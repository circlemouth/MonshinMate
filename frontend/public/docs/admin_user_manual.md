# 管理画面の使い方

本書は、日常の運用で管理画面を利用するための基本的な操作方法を説明します。

## 1. ログイン
1. 患者画面右上の「管理画面」ボタンを押します。
2. 管理者パスワードを入力してログインしてください。
   - 初期パスワードのままの場合は、新しいパスワードの設定が求められます。

## 2. ダッシュボード画面の確認ポイント
- ログイン後は左メニューの「ダッシュボード」が自動的に開きます。ここでは初診・再診を問わず最新の問診データをまとめて確認できます。
- 画面上部の表には、問診セッション（初診/再診）の最新10件が表示されます。
  - 各行には患者名・受診種別・問診日時が並び、行をクリックすると詳細画面に遷移します。
  - 「出力」ボタンから PDF / Markdown / CSV を個別に出力できます。Markdown はワンクリックでクリップボードにコピーされます。
  - 10件を超える履歴や検索を行いたい場合は、左メニューの「問診結果一覧」を利用してください。
- 表の下には以下の情報カードが並びます。
  - **使用中テンプレート**: 現在登録されているテンプレートIDと、初診/再診で利用できるかどうか、既定テンプレートIDが確認できます。
  - **データベース**: CouchDB を利用中か、SQLite を利用中か、エラーが発生していないかを色付きのタグで表示します。
  - **LLM**: 疎通テストの結果（疎通良好/接続エラー/無効）に加え、設定中のプロバイダ名とモデル名、接続先URLを表示します。
    - LLMが無効化されている場合はその旨が表示されます。
    - エラー表示の場合は疎通テストが失敗しているため、設定を確認してください。

## 3. システム表示名の編集
1. 左メニューの「システム表示名」を開きます。
2. クリニック名などの表示名を入力し、「保存」を押します。
3. 保存後、患者向け画面に即時反映されます。

## 4. ロゴ / アイコン
1. 左メニューの「外観設定」でロゴ画像をアップロードします。PNG / JPEG など一般的な形式に対応しています。
2. アップロードが成功すると「表示範囲を調整」ボタンが利用できます。ボタンを押すとモーダルが開き、青い枠をドラッグして表示範囲を調整できます。
3. モーダル内では数値入力欄や「全体」「正方形」ボタンも利用できます。モーダルを閉じても調整内容は自動保存され、すぐに患者画面と管理画面へ反映されます。
4. ファイル名に空白や日本語が含まれていても安全な名称に変換されるため、そのままアップロードできます。

## 5. テーマカラーの変更
1. 左メニューの「テーマカラー」を開きます。
2. パレットから色を選ぶか、カラーコードを入力します。
3. 「保存」を押すと全画面に反映されます。

## 6. 問診テンプレートの管理
1. 左メニューの「テンプレート」を開きます。
2. テンプレートを作成・編集し、必要に応じて問診項目を追加します。
   - 各項目には画像を添付できます。アップロードした画像は設定画面でプレビューされ、患者画面では質問と補足説明の下に大きく表示されます。
     - プレビュー画像をクリックするとモーダルで拡大表示されます。
     - 「画像を削除」ボタンを押すと確認ダイアログが表示され、承認後に削除されます。
     - 画像を設定した項目は項目一覧のラベル右側に画像アイコンが表示されます。
   - 選択肢ごとに条件分岐の追加入力欄を設定でき、特定の回答時のみ表示される追加質問を最大2階層まで追加できます。
     - 各選択肢の右側に表示される「？」アイコンにマウスを乗せると「追加質問を追加」の案内が現れ、クリックで編集モーダルが開きます。モーダルを開いた直後から新しい追加質問の入力欄が表示されるため、すぐに内容を編集できます。
     - 問診項目一覧に表示された追加質問をクリックすると、該当する追加質問を編集するモーダルが開きます。
   - 患者画面では条件を満たした場合に通常の質問としてその場に差し込まれ、特別な表示は行われません。
   - 追加質問を設定した選択肢には「枝」マークが表示され、項目一覧では追加質問が一段下げて表示されます。
   - 入力方法としてスライドバーを選択でき、最小値と最大値を設定可能です（既定は0〜10）。
   - 「性別で表示を制限」のチェックボックスをオンにすると、性別のプッシュボタンが表示されます。ラベルは「男性のみに質問」「女性のみに質問」となり、どちらかを選択して対象性別を指定できます。
   - 「年齢で表示を制限」をオンにすると、年齢範囲スライダーで表示対象の年齢帯を設定できます。スライダーは表示範囲の横幅の 2/3 で中央揃えで表示されます。患者の情報が条件に合致しない場合、その質問は表示されません。
3. 右上の「プレビュー」で患者画面での表示を確認できます。

## 7. LLM 設定
1. 左メニューの「LLM設定」を開き、利用するプロバイダや接続先を設定します。
2. 設定保存時に自動で疎通テストが行われ、結果が表示されます。
3. 追質問やサマリ作成を利用する場合は、この設定が有効である必要があります。
4. モデル名の入力欄にある「使用可能なモデル一覧を取得」の右側の「疎通テストを実行」で手動テストすると、結果は画面右上の通知で確認できます。

## 8. 問診結果の確認
1. 左メニューの「問診結果」で送信済みセッションを確認できます。
2. 各行のアイコンから PDF / Markdown / CSV 形式で結果をダウンロードできます。
   - PDF は患者情報・質問・追質問を罫線付きのフォームとして配置し、紙の問診票に近いレイアウトで出力されます。
   - 管理メニューの「PDFレイアウト」設定から、必要に応じて従来のシンプルなレイアウト（レガシー）へ切り替えできます。

## 9. データベース/LLM の稼働状況表示
- 「ダッシュボード」画面のカードで、現在利用中のデータベース種別・LLM疎通状態・モデル名を一目で確認できます。
  - 緑「DB:CouchDB」: CouchDB に接続できています。
  - 青「DB:SQLite」: CouchDB 未使用で SQLite を利用しています。
  - 赤「DB:接続エラー」: データベースに接続できていません。
  - LLM カードでは疎通状態（疎通良好/接続エラー/無効）と設定中のモデル名・接続先が表示されます。
- 画面上部のヘッダーにも従来通りバッジが表示され、どのページにいても状態を確認できます。

## 10. さらに詳しい情報
システム全体のセットアップ手順やトラブルシューティングは [admin_system_setup.md](/docs/admin_system_setup.md) を参照してください。


## 11. 設定と問診データのバックアップ
- **テンプレート設定のエクスポート/インポート**
  - 「テンプレート」画面下部のカードから、テンプレート・各種プロンプト・項目画像をまとめてダウンロードできます。
  - パスワードを指定すると暗号化された JSON ファイルとして出力され、同じパスワードを指定してインポートできます。
  - インポート時は「既存に上書き（merge）」または「入れ替え（replace）」を選択できます。入れ替えは現在のテンプレートと画像が全て削除されるためご注意ください。
- **問診データのエクスポート/インポート**
  - 「問診結果」画面上部にエクスポート/インポート用のカードが追加されています。
  - 選択中のセッションがあればその分のみ、選択が無ければ検索結果に表示されている全件を JSON 形式でダウンロードできます。こちらも任意のパスワードで暗号化可能です。
  - インポート時は既存データに追加（merge）するか、全件入れ替えるか（replace）を選択してください。入れ替えを選ぶと保存済みの問診データが削除されるため、事前にバックアップを取得してから実施してください。
