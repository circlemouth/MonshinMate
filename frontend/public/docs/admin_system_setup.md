# 管理画面によるシステム全体セットアップ手順

本書では、管理画面を用いてシステムを運用開始できる状態にするまでの流れを説明します。初期セットアップや設定変更時の参考にしてください。

## 1. 管理画面へのログイン
1. 患者画面右上の「管理画面」ボタンをクリックすると、ログイン用のモーダルが画面内に表示されます。
2. パスワードが初期状態（"admin"）の場合、まずパスワード設定モーダルが開きます。新しいパスワードを2回入力して保存してください。
   - 保存後、Authenticator を有効にするか確認するダイアログが表示されます。QR コードを表示して有効化するか、後で設定するかを選択できます。
   - Authenticator を有効にしない場合、パスワードのリセット機能は利用できません。パスワードを忘れた場合はパスワードリセットページにシステム初期化（`backend/tools/reset_admin_password.py` の実行）を指示する案内が表示されます。後から設定したい場合は管理画面の「セキュリティ」から行ってください。
   - 環境変数 `ADMIN_PASSWORD` を既に独自設定している場合はその値が初期値として引き継がれるため、このモーダルは表示されません。
   - 旧バージョンで `app_settings` に保存されていた `admin_password` は起動時に無視され削除されます。初期パスワードを指定したい場合は環境変数 `ADMIN_PASSWORD` を利用してください。
3. 既にパスワードが設定済みの場合はログイン画面が表示されます。管理者パスワードを入力し、「ログイン」を押します。
   - パスワードを誤入力すると「パスワードが間違っています」と表示されます。
4. 二段階認証を有効にしている場合は、パスワード送信後に確認コード入力画面が同じモーダル内に表示されます。
5. 認証に成功するとテンプレート一覧ページが開きます。
    - TOTPを有効化しているにもかかわらずシークレットが失われている場合、ログインと同時に二段階認証は自動的に無効化されます。
    - 管理画面から二段階認証を無効化するとシークレットは直ちに削除され、再度有効化する際は新しいQRコードの読み込みが必要です。
    - 現在のパスワードが環境既定値（`ADMIN_PASSWORD` が未設定なら "admin"）と一致している場合のみ、`POST /admin/password` による直接変更が許可されます。それ以外はパスワードリセットフローを利用してください。
    - セキュリティ画面の「パスワードの変更」から現在のパスワードを入力して更新できます。変更すると二段階認証は自動的に無効化されるため、必要に応じて再設定してください。

## 2. システム表示名の設定
1. 左メニューから「システム表示名」を選択します。
2. 表示されたフォームにクリニック名など任意の表示名を入力し、「保存」を押します。
3. 保存後、患者向け画面のヘッダーに即時反映されます。

## 3. テーマカラーの設定
1. 左メニューから「テーマカラー」を選択します。
2. 表示されたパステルカラー一覧から選ぶか、カラーコードを入力して任意の色を指定します。
3. 「保存」を押すと全画面に即時反映されます。

## 4. 問診テンプレートの準備
1. 左メニューの「テンプレート」を開きます。
2. 「新しいテンプレート名」を入力してテンプレートを作成します。初診用と再診用をそれぞれ作成してください。
3. 問診項目一覧の下にある「問診項目を追加」ボタンから、質問文・補足説明・入力方法・必須設定・初診/再診への適用を設定します。
4. 条件表示を利用する場合は `when` 設定で表示条件を追加できます。
5. 右上の「プレビュー」ボタンで患者画面での表示を確認します。
6. 編集内容はユーザー操作時に自動保存されます。必要に応じて保存完了を確認してください。
7. サマリーを自動作成する場合は「サマリー作成を有効化」にチェックを入れ、必要に応じてプロンプトを設定します。無効のままだと要約は空欄になります。

## 5. LLM 設定
1. 左メニューの「LLM設定」を開きます。
2. `provider` を選択します（`local`/`ollama`/`lm_studio`）。
3. 遠隔サーバーを利用する場合は `base_url` と `api_key` を入力します。
4. 「保存」を押すと自動で疎通テストが実行されます。失敗した場合はポップアップでエラーメッセージが表示されます。
5. テンプレート側の「追質問を有効化」チェックは、LLM設定が有効かつ疎通テストに成功している場合のみオンにできます。
6. 画面上部のバーの色で接続状況を確認できます（緑=接続中、赤=エラー、灰=無効）。
7. サマリ作成や追加質問生成で通信エラーが発生した場合は、LLM を使わない設定に自動的にフォールバックして処理を継続します。

## 6. 動作確認
1. 左メニューの「問診結果」で送信済みセッションを確認できます。患者名・生年月日・問診日の範囲で絞り込み検索が可能です。
   - 各行の右端にあるアイコンから PDF / Markdown / CSV 形式で結果をダウンロードできます。
2. 患者画面に戻り、新しいセッションを開始して各設定が反映されているか確認します。

## 7. 付録：使い方ページ
管理メニューの「使い方」ページでは、本ドキュメントが表示されます。院内マニュアルとして活用してください。

## 8. 付録：オフラインでの管理者パスワード初期化と二段階認証の無効化

障害対応やログイン不能時に、バックエンド同梱のメンテナンススクリプトで管理者アカウントを復旧できます。操作は自己責任で行い、実施前に必ずDBのバックアップを取得してください。

- スクリプトの場所: `backend/tools/reset_admin_password.py`
- 事前バックアップ: `backend/app/app.sqlite3` をコピー保全
- 対応内容:
  - 管理者（`username='admin'`）のパスワードを新しい値で上書き
  - `is_initial_password=1`（初期パスワード扱い）に設定
  - 二段階認証を完全無効化: `is_totp_enabled=0`, `totp_mode='off'`, `totp_secret=NULL`
  - 管理者が存在しない場合は新規作成

### 使い方

1) 対話的に実行（推奨）

```bash
python backend/tools/reset_admin_password.py
```

プロンプトに従い新しいパスワード（8文字以上）を2回入力し、最終確認で `yes` を入力します。

2) 非対話で実行

```bash
python backend/tools/reset_admin_password.py --password "NewStrongPass123"
```

3) DBパスの指定（任意）

```bash
export MONSHINMATE_DB=/path/to/app.sqlite3
python backend/tools/reset_admin_password.py --password "NewStrongPass123"
```

環境変数 `MONSHINMATE_DB` があればそれを使用し、指定がない場合は `backend/app/app.sqlite3` を参照します。`--db` オプションでも明示指定可能です。

### 実行後の挙動

- 管理画面アクセス時、パスワードは新規設定済みですが「初期パスワード扱い（is_initial_password=1）」のため、初回ログインフローでの挙動が簡略化されます。
- 二段階認証は完全に無効化されています（`totp_mode='off'`）。必要であれば管理画面の「セキュリティ」から再度QRコードを発行し、有効化してください。

### 注意事項

 - 既存DBに `totp_mode`, `password_updated_at`, `totp_changed_at` カラムが存在しない場合でも、スクリプトが自動で追加します（既存環境に影響が出ないよう例外は握り潰します）。
- 本スクリプトはローカル実行を前提としています。運用環境での実行は手順、権限、監査ログの扱いに注意してください。

## 9. 付録：監査ログの確認方法（開発向け）

パスワードや二段階認証（TOTP）の変更原因を追跡できるよう、開発環境では監査ログを出力しています。平文パスワードやハッシュ値は記録しません。

- 出力先（ファイル）
  - `backend/app/logs/security.log`
  - 主要イベントを時系列で出力（ローテーションあり、最大約1MB×5世代）
  - 例（抜粋）:
    - `startup_admin_status ...`（起動時の管理者状態）
    - `password_update username=admin ...`（パスワード更新）
    - `totp_enabled/disabled ...`（TOTPの有効/無効化）
    - `totp_mode_set ...`（TOTPモード変更）
    - `password_reset_token_issued / password_reset_confirmed`（リセットフロー）
    - `forced_password_reset ...`（オフライン初期化スクリプト実行）

- 監査テーブル（DB）
  - SQLite の `audit_logs` テーブルに重要イベントを保存しています（ファイルと二重に記録）。
  - 確認用ユーティリティ: `backend/tools/audit_dump.py`
    - 直近100件を表示（既定）: `python backend/tools/audit_dump.py`
    - 件数指定: `python backend/tools/audit_dump.py --limit 200`
    - 別DBを指定: `MONSHINMATE_DB=/path/to/app.sqlite3 python backend/tools/audit_dump.py`
  - 代表的なイベント名:
    - `password_update`, `users.password_updated`
    - `admin_user_created`
    - `totp_secret_updated`, `users.totp_secret_updated`
    - `totp_status_changed`, `users.totp_status_updated`
    - `totp_mode_changed`, `users.totp_mode_updated`
    - `forced_password_reset`

注意:
- APIとしては公開していません（開発時のローカル確認のみを想定）。
- 運用環境での取り扱いは院内ポリシーに従い、アクセス権限・保管期間・持ち出し制限などに留意してください。


## 10. 付録：TOTPシークレット暗号化への移行手順

既存DBでTOTPを利用している場合、バージョン更新後はシークレットを暗号化する必要があります。
以下の手順で移行してください。

1. 暗号化キーを生成し環境変数 `TOTP_ENC_KEY` に設定します。例:
   ```bash
   python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
   export TOTP_ENC_KEY="<生成したキー>"
   ```
2. バックエンドディレクトリで次のスクリプトを実行します。
   ```bash
   python backend/tools/encrypt_totp_secrets.py
   ```
   既に暗号化済みのレコードは自動的にスキップされます。
3. サービスを再起動し、通常どおりログインできることを確認します。
