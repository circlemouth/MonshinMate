# 実裁E頁EEEinimal 牁E/ v1EE

> 重要な注意（更新E：既定ではローカルLLMのみを使用しますが、管琁E面の設定で任意に「リモートE Ollama / LM Studio サーバE」を持E可能です。リモート設定を有効にした場合E当該サーバEへプロンプト・入力が送信されます。院冁E用ポリシーに従い、忁Eな場合Eみ有効化してください。フチEーの注意書きE「既定Eローカル運用で外部送信なし。リモートを有効にした場合E送信あり」に読み替えてください、E

本書は、これまで合意した **「実裁E画書EEinimal 版）、E* と **「フロントエンドUI構築設計書、E* に整合する形で、段取りEEイルストEン・WBSEと実施手頁E示します。禁忁E赤旗E辞書正規化・緊急刁EE同意画面・重褁EE吁EID発行EハEドガード追質問Eスコープ外です、E

---

## 0. 目皁E/ スコーチE
- 目皁EE
  - 患老E・生年月日の入劁EↁE初診/再診刁EEↁEチEプレートに基づくEース問診 ↁELLMによる最小追加質啁EↁE完亁EまでめE**細ぁE緁E* で実裁Eる、E
- スコープ！E
  - 患老Eけフローと管琁E面Eテンプレート管琁ELLM接続設定！E
  - バックエンドAPIEセチEョン、テンプレーチERUD、LLM質問生成、最終化EE
- 非スコープ！E
  - 禁忁E赤旗、辞書・正規化、緊急時E岐、ルールベEス追質問、同意画面、E褁EE吁EID発衁E

---

## 1. マイルストEンEESEと完亁E件

### MS1E管琁EI/チEプレ整傁E
- 目皁EE診/再診チEプレートECRUDとプレビューを提侁E
- **完亁E件**
  - [x] チEプレート一覧/新要E編雁E削除が動佁E
  - [x] 新規テンプレートE既定問診頁Eラベルを「質問文形式」に統一E例！E主訴は何ですかEE、E発痁E期EぁEからですかEEEE
- [x] 頁Eごとに「E診」「E診」への適用可否をチェチEボックスで設宁E
  - [x] 条件表示E軽釁EwhenEE保孁E反映
  - [x] プレビューで患老EE画面の疑似レンダリング
    - `when` は `{ "item_id": 参E頁EID, "equals": 値 }` 形式で、条件が満たされた場合にのみ対象頁Eを表示する、E

### MS2EセチEョン基盤
- 目皁EセチEョン生Eと状態E移EEntry→種別→問診→追加質問E確認E完亁EE
- **完亁E件**
  - [x] `POST /sessions` でセチEョン作E
  - [x] 進行状態！Eemaining_items / completion_status / attempt_countsEE保持
  - [x] 画面遷移ガード（未入力時の差し戻し！E

### MS3ELLM追加質問ルーチE
- 目皁E不足頁EのみめE*上限N件**で質問し、ターン制御で補宁E
- **完亁E件**
  - [x] `POST /sessions/{id}/llm-questions` ぁE`questions[]` を返す
  - [x] 優先度頁E提示し、回答送信→E計算E終亁E件EE件/上限/手動終亁EE
  - [x] 頁Eごとの再質問E最大3回、セチEョン合計E上限NはチEプレートで設定可能
  - [x] 回答をまとめてLLMへ送信し、追加質問を一括生Eする

### MS4E要紁E保孁E
- 目皁EE回答E一覧確認E確定E保孁E要紁EE劁E
- **完亁E件**
  - [x] 追加質問終亁E、E動的にセチEョンを確定して要紁E生E
  - [x] `POST /sessions/{id}/finalize` ぁE`summaryText` と `allAnswers` を返す
  - [x] 完亁EチEEタスとタイムスタンプ保孁E
  - [x] LLM 設定が有効かつ疎通OKの場合、バチEグラウンドでカスタムプロンプトを用ぁEサマリー生Eを実行！EIは非ブロチEングEE
  - [x] サマリープロンプトはチEプレート管琁E面から「E診」「E診」それぞれ編雁E保存可能

### MS5Eフロント実裁E患老E管琁EE
- 目皁EUI導線と状態管琁EE実裁E
- **完亁E件**
  - [x] **患老E*EEntryE氏名/生年月日E受診種別EE Questionnaire ↁEQuestions ↁEDone
    - [x] Entry で氏名・生年月日をE劁E
    - [x] Entry で「当院の受診は初めてですかE」を選択（「Eめて、E initial / 「受診したことがある、E followupEしセチEョン作E
    - [x] Questionnaire で text/multi/yesno/date に応じたE力フォームを表示
    - [x] Questions で追加質問を頁E表示
    - [x] 追加質問終亁EE自動的に完亁E面へ遷移
  - [x] Done で要紁E表示
  - [x] **共送E*EEチEー右上「管琁E面」Eタン、フチEー注意文の常時表示
- [x] **管琁E*Eログイン→テンプレートE問診結果→LLM設宁E
  - [x] 問診結果一覧と詳細表示

### MS6Eログ/観測性E最小！E
- 目皁E障害時E原因追跡と操作把握
- **完亁E件**
  - [x] セチEョン遷移、APIエラー、LLM I/OメタE所要時間）E記録
- [x] /readyz, /health の簡易エンドEインチE

### MS7EリモーチELM接続（任意！E
- 目皁EOllama / LM Studio の遠隔サーバEへ接続可能にする
- 完亁E件
  - [x] `LLMSettings` に `base_url`/`api_key` を追加E任意頁EEE
  - [x] `provider=ollama` 時E `POST {base_url}/api/chat` を使用
  - [x] `provider=lm_studio` 時E OpenAI互換 `POST {base_url}/v1/chat/completions` を使用
  - [x] `/llm/settings/test` は `base_url` 未設定時は常に OK、設定時は疎通を確誁E
  - [x] 失敗時はログ出力E上、スタブ応答にフォールバック
  - [x] 追加質問生成で構造化E力を強制EELMcommunication.md 準拠EE
    - Ollama: `/api/chat` の `format` に JSON SchemaEEarray<string>`、maxItems=上限Eを持EE
    - LM Studio: `/v1/chat/completions` の `response_format.json_schema` に同スキーマを持EE
    - 返却は斁EEJSONのため受信後に `json.loads()` でパEスして配Eに変換
    - プロンプト側でも「JSON配Eで返答」を明記（E長対策！E

> 実裁EモEE025-08-27E：`backend/app/llm_gateway.py::generate_followups` を更新し、E
> LM Studio / Ollama 双方に対して JSON Schema による構造化E力を強制するよう変更、E
> これにより不正な斁EE混入を防ぎ、EE列パースの安定性を向上、E

### MS7EUAT / 受け入めE
- 目皁Eエンドツーエンド検証
- **完亁E件**
  - [x] 初診/再診の代表チEプレで入力E追加質問E確定が成功
  - [x] LLM無効時でもEース問診のみで完亁E
  - [x] 受け入れ基準（§10Eを満たす

---

## 2. 作業手頁EEBSEE

### 2.1 バックエンチE
1) **モチE/スキーチE*
   - [x] `questionnaires`Eテンプレメタ + items[]EE
   - [x] `sessions`E進行状態E完亁Eラグ・timestampsEE
   - [x] `session_responses`EE回答E追加質問E履歴EE
   - [x] 問診頁Eに対象性別を追加し、テンプレート取得時にフィルタできるようにしたE未設定時は男女ともに表示EE
2) **サービス**
   - [x] `SessionFSM`E`step("answer")`、`_finalize_item`、attempt/turn/questions 上限管琁E
   - [x] `LLMGateway`E`generate_question`、`decide_or_ask`、`summarize`EタイムアウチE再試行！E
   - [x] `Validator`E忁EE型E篁Eのみ
   - [x] `StructuredContextManager`E`update_structured_context`
3) **API**
   - [x] `POST /sessions`E患老E・生年月日・visitType・questionnaireIdEE
   - [x] `POST /sessions/{id}/answers`EEース問診保存！E
  - [x] `POST /sessions/{id}/llm-questions`E不足の抽出EE
   - [x] `POST /sessions/{id}/llm-answers`E追加質問への回答E保存！E
   - [x] `POST /sessions/{id}/finalize`E要紁E成と確定！E
   - [x] 管琁EE`GET/POST /questionnaires`, `GET /questionnaires/{id}/template`, `DELETE /questionnaires/{id}`
   - [x] 管琁EEサマリープロンプトE：`GET /questionnaires/{id}/summary-prompt?visit_type=...`, `POST /questionnaires/{id}/summary-prompt`
4) **観測性**
   - [x] /readyz, /health, /metricsE簡易！E

### 2.2 フロントエンチE
1) **共送E*
   - [x] ルーチEング骨格、EチEー/フッターE注意文常時表示EE
   - [x] 管琁E面ルートではヘッダー右上Eタンを「戻る」に刁EEEの画面へ戻れるよう改喁EE
2) **患老EぁE*
   - [x] `/`E氏名・生年月日E受診種別の入力（選択後にセチEョン作E→`/questionnaire` へEE
   - [x] `/questionnaire`Eテンプレに基づくフォームE軽量条件表示、ドラフト保存！E
   - [x] 性別に応じた問診頁Eの出しEぁE
   - [x] `/questions`ELLM追加質問（モーダル or カードEEと進行インジケータ
   - [x] `/done`E完亁EチEージと要紁E印刷/コピE任意！E
3) **管琁EぁE*
   - [x] `/admin/login`E管琁EEグイン
   - [ ] `/admin`EダチEュボEド（廁EEE
 - [x] `/admin/templates`E一覧/新要E編雁E褁E/削除
  - [x] `/admin/templates/:id`E頁Eごとに初診/再診の使用可否めE象性別を設定する表とプレビュー
  - [x] `/admin/sessions`E問診結果の一覧
  - [x] `/admin/sessions/:id`E質問と回答E詳細表示
  - [x] `/admin/llm`E接続設定（エンドEインチEモチE/上限N/ターン/タイムアウト）と保存時の自動疎通テスチE
4) **状態管琁E永続化**
 - [x] sessionStorageドラフト、画面遷移ガーチE
  - [x] 再試行キューEネチEワークエラー時に未送信の回答をsessionStorageに蓁Eし再送EE

---

## 3. フロント—バチEエンチEI/FE契紁EE
- `GET /questionnaires?visitType=initial|followup` ↁE`QuestionItem[]`
- `POST /sessions` ↁE`{ sessionId }`
- `POST /sessions/:id/answers` ↁE`{ ok }`
- `POST /sessions/:id/llm-questions` ↁE`LlmQuestion[]`
- `POST /sessions/:id/llm-answers` ↁE`{ ok, remaining }`
- `POST /sessions/:id/finalize` ↁE`{ summaryText, allAnswers, finalizedAt, status }`
- 管琁EE`GET /questionnaires`, `POST /questionnaires`, `DELETE /questionnaires/{id}`, `POST /questionnaires/{id}/duplicate`, `GET/PUT /admin/llm`, `POST /admin/login`
- 管琁E結果閲覧E`GET /admin/sessions`, `GET /admin/sessions/{id}`

> API 名称は最終的にバックエンド設計に合わせて微調整して良ぁEE

---

## 4. 画面/ルーチEング仕様（要点EE
- **ヘッダー**E左ロゴ、右上「管琁E面」EタンE常時）、E
- **フッター**E`本シスチEはローカルLLMを使用しており、外部へ惁Eが送信されることはありません。`
- **Entry**E氏名E忁E）E生年月日E忁E、E去日付EみEE
- **管琁Eグイン**EEadmin/login でID/メール + パスワード。E功で /admin/templates へ、E
- **管琁E*EテンプレCRUD、LLM接続設定（テストEタンE、E

---

## 5. バリチEEション / エラーE最小！E
- 忁E：未入力Eフィールド直下にエラー、E
- 垁E篁EE数値/日付E基本チェチEのみ、E
- API失敗：トースト表示EE試行Eタン、ELM応答なし時は追加質問スチEプをスキチEE、E

---

## 6. チEEタ保孁E/ 状慁E
- `session`Eid、questionnaireId、visitType、E捗、作E/更新、完亁Eラグ、E
- `collected_data`EEース問診 `{頁EID: 値}` と追加質啁E`[{id, text, answer, ts}]`、E
- `SessionResponse`E表示斁EE回答E履歴、E

---

## 7. チEト手頁E
- **ユニッチE*E`LLMGateway`EモチEE、`Validator.is_complete`、`SessionFSM`、E
- **結合/E2E**EE診/再診チEプレで入力E追加質問E確定、E
- **UI**Eモバイル操作、未入力E型エラー、ネチE断Eドラフト復帰E、E
- 実行例！E
  - バックエンド：`cd backend && pytest`EEpytest-asyncio` が忁Eな場合E追加EE
  - フロント：E2E は Playwright/Cypress ぁEれかで用愁E

---

## 8. リリース手頁E
1) DBマイグレーションEテンプレ・セチEョン関連EE
2) 管琁E面で `llm_settings` と初診/再診チEプレ投E

---

## 変更履歴E運用メモEE
- [fix] 管琁E面チEプレ設定ELLM有効判定を調整E疎通OKのみで有効化）、E
  - これまで base_url が未設定だと UI のトグルが無効化されてぁEが、スタブ（ローカルE運用では base_url なしでめE`/llm/settings/test` ぁEOK を返すため、UI 側の可否判定を疎通テスト結果のみに変更、E
  - 対象: `frontend/src/pages/AdminTemplates.tsx` の `llmAvailable` 判定、E
3) スチEEジングでUAT→本番ロールアウチE

---

## 9. 受け入れ基準（抜粋！E
- ベEス問診のみでもセチEョンを完亁Eきる
- 追加質問E上限N件を趁EなぁE/ 頁Eごとの再質問E最大3囁E
- 完亁E面では回答一覧の編雁EE行わなぁE
- スタチE向け要紁E生Eされ、印刷/EMR貼付に足る簡潔さ
- UI上に **「ローカルLLM利用・外部送信なし、E* が恒常表示

---

## 10. 運用メモE最小！E
- LLM障害時E追加質問フェーズをE動スキチEEEEース問診で完亁EE
- チEプレ変更はドラフト→E開で反映。E開中のセチEョンには影響しなぁE新規EみEE

---

## 11. UIチEイン改修E医療問診向けEチェチEリスチE
> 詳細方針E `docs/UI_Redesign_Plan.md` を参照。plannedSystem.md と整合、E

- [ ] チEイン原則と惁E設計E合意E患老E管琁EローEE
- [x] チEイントEクン定義E色・タイポE間隔・ブレークポイント！E
- [x] カラーパレチE AA コントラスト検証E主要画面EE
- [x] タイポグラフィ設定（日本誁E英数孁E等幁E字！E
- [ ] コンポEネント実裁EEutton/Input/Radio/Checkbox/Select/DatePickerEE
- [x] 進行表示EEtepper/ProgressE、E知EElert/ToastE、確認！EodalEE
- [x] フォームUXEバリチEEション、エラー表示、E力補助EE
- [ ] レイアウチEレスポンシブ最適化！EPad/1080p/チEクトップ！E
- [x] アクセシビリチE対応（フォーカス・aria・キーボEド操作！E
- [x] フッター安忁E示の統一EローカルLLM/外部送信なし！E
- [x] 印刷スタイルE医師向け要紁EE体裁EE
- [x] UIイベント計測E匿名メトリクス、E脱/滞留EE
- [ ] 受け入れテスト（看護/事務レビュー、UAT 合格EE

---

## 12. バグ修正履歴Eフロントエンド！E
- [x] Entry.tsx の重褁Eimport を解消！EuseState` が二重宣言E。ビルド時の `Identifier 'useState' has already been declared` エラーを修正。！E025-08-20EE
- [x] 管琁E面の問診結果詳細で受診種別が英語表記となる問題を修正し「E診/再診」と表示。テンプレート管琁E面の頁Eタイプ「YES/NO」も「EぁEぁEえ」に変更し、削除ボタンの aria-label を日本語化。！E025-08-22EE
- [x] 問診結果詳細のサマリー表示に改行を挿入し、各頁Eが見やすくなるよぁE喁E！E025-08-22EE
- [x] 管琁E面のパスワードリセチEで、ローチEングダイアログと二段階認証コードE力が高速で刁E替わり操作不Eになる不E合を修正。原因は `AuthContext` の `checkAuthStatus` が毎レンダで再生成され、依存してぁE画面の `useEffect` が連続発火してぁEこと。`useCallback` により参Eを安定化し、`App.tsx` の全画面ローチEングとの競合を解消。！E025-08-27EE
- [x] `checkAuthStatus` にローチEング抑制フラグを追加し、パスワードリセチE画面などで無限リクエストが再発しなぁEぁE正。コンチEスト更新時E全画面ローチEングを回避。！E025-08-29EE

---

## 13. 管琁E面ナビゲーション改喁EE025-08-22EE
- [x] 管琁E面に左サイドバーEEAdminLayout`Eを追加し、テンプレーチE問診結果/LLM設定へワンクリチE移動を実裁EE
- [x] 右上EチEーボタンの斁Eを「戻る」E「問診画面に戻る」に変更EEApp.tsx`E、E

## 14. ダチEュボEド廁EEE025-08-30EE
- [x] `/admin` を廁EぁE`/admin/templates` へリダイレクト、E
- [x] ログイン後E遷移先を `/admin/templates` に変更、E

## 15. チEプレート管琁EIの可読性改喁EE025-08-22EE
- [x] チEプレート管琁E面の表めE`TableContainer` でラチEEし、横スクロールを許可、E
- [x] 問診冁E・入力方法E選択肢の吁EEに最小幁E設定し、`tableLayout="fixed"` と `minWidth` により冁Eが見EれなぁEぁE整、E
- [x] 既存テンプレート一覧チEEブルにめE`minWidth` を設定し、小画面での可視性を改喁EE

## 16. チEプレート管琁EIのカード表示Eレスポンシブ）！E025-08-22EE
- [x] 画面幁E`lg` 未満では、問診頁E一覧をカード形式で表示EECard`/`CardHeader`/`CardBody`E、E
- [x] カード上段に「問診冁E」、中段に「E力方法＋削除ボタン」、下段に「選択肢EEulti時EみE」と「忁EE初診/再診」EチェチEをE置、E
- [x] `useBreakpointValue({ base: true, lg: false })` でカーチEチEEブルをE動E替。`lg` 以上E画面では従来の表E幁E喁EEを保持、E

## 17. チEプレ頁E一覧の常時カード化EE025-08-22EE
- [x] レスポンシブE替を廁Eし、常にカード表示へ統一E一覧性より可読性を優先）、E
- [x] 不要となったテーブル牁EIと関連インポEトを整琁E既存テンプレ一覧チEEブルは維持E、E

## 18. チEプレ一覧の表記とプレビューの挙動変更EE025-08-22EE
- [x] 見Eし「既存テンプレート一覧」E「保存済みチEプレート一覧」に改称、E
- [x] チEEブル列名「ID」E「テンプレート名」に変更。`default` の表示は「デフォルト」に置換、E
- [x] 画面下部の常設プレビューを廁Eし、「Eレビュー」Eタンからモーダル表示に変更、E
- [x] プレースホルダー「新しいチEプレートEID」E「新しいチEプレート名」に変更、E
- [x] 問診結果一覧は行クリチEで詳細E問診冁EEをモーダル表示するよう変更E画面遷移を置換）、E

## 19. 褁E選択頁Eの自由記述対応！E025-08-22EE
- [x] 管琁E面で褁E選択頁Eに「E由記述を許可」設定を追加、E
- [x] 設定有効時、患老E面とプレビューで自由入力欁E表示し回答に含める、E
- [x] バリチEEションで選択肢外E斁EEを許可、E

## 20. チEォルト問診頁Eの拡允EE025-08-22EE
- [x] 初診チEプレートに氏名・生年月日・性別・住所などの基本惁Eと痁E関連頁Eを追加、E
- [x] 再診チEプレートを主訴・痁E部位E発痁E期に限定したE容で初期化、E

## 21. Windows 向け一括起動スクリプト追加EE025-09-27EE
- [x] PowerShell スクリプト `dev.ps1` を追加し、バチEエンドとフロントエンドを同時起動できるようにした、E
- [x] README に `dev.ps1` の使ぁEを追記、E

## 22. LLM フォローアチEE質問EチEプレート設定！E025-10-30EE
- [x] 固定フォーム終亁Eに LLM による追加質問を行うかどぁEをテンプレートで設定可能にした、E
- [x] 設定値は DB に保存され、セチEョン作E時に反映される、E
- [x] LLM 設定が無効またE疎通テストに失敗してぁE場合E、管琁E面で追質問E設定をオンにできなぁEぁEした、E

## 23. LLM フォローアチEE判定征E画面の追加EE025-10-31EE
 - [x] 固定フォーム回答後、追質問E有無を判定する間に征E画面を表示するようにした、E
 - [x] 判定結果に応じて追加質問画面またE完亁E面へ自動E移する、E

## 24. 管琁EチャチE画面の左右余白を削減！E025-08-23EE
- [x] 管琁E面のコンチEをE幁Eし、左右パディングを縮小、E
  - 変更: `frontend/src/App.tsx`EEisAdminPage` 時E `Container` めE`maxW="100%"`, `px={2}`EE
  - 変更: `frontend/src/components/AdminLayout.tsx`EEgap` めE`6ↁE`、ナビ幁E `180/220pxↁE60/200px`、E体に `px` 追加EE
- [x] チャチE画面の冁EEパディングを縮小、E
  - 変更: `frontend/src/pages/LLMChat.tsx`EEp={4}` めE`px={{ base: 2, md: 3 }}` に変更。E力バーも同様！E
- [x] 回帰確認としてバックエンチE`pytest` 実行！E3 passed, warnings のみE、E

## 25. 管琁Eンプレ画面の初期ロード時の自動保存抑止EE025-08-23EE
- [x] 初回ローチEチEプレ刁E直後に保存UIが動作せず、実保存もしなぁEぁE御、E
  - 変更: `frontend/src/pages/AdminTemplates.tsx` に `isDirtyRef` を追加し、ユーザー操作時のみ自動保存を起動、E
  - ユーザー操作（頁E追加・編雁EE削除、Eロンプト/フラグ変更E時に `markDirty()` を呼ぶようイベントハンドラを調整、E
  - ロード完亁E/保存完亁Eに dirty をリセチE、E

## 26. LLM 設定が保存されなぁE題E修正EE025-08-23EE
- [x] 取得APIをDB優先に変更し、保存後E再取得でUIへ反映、E
  - 変更: `backend/app/main.py` の `GET /llm/settings` は DB を読み、あれEメモリへ反映して返す、E
  - 変更: `frontend/src/pages/AdminLlm.tsx` は `PUT` 後に `GET /llm/settings` をE実行して設定を再描画、E

## 27. チEォルトテンプレートから氏名・生年月日を削除EE025-08-23EE
- [x] 初診・再診の「デフォルト問診頁E」かめE`name`/`dob` を除外（それらはセチEョン作E時に別途E力！E
  - 変更: `backend/app/main.py` の `on_startup()` 冁E`initial_items` から `name`/`dob` を削除、E
  - チEト更新: `backend/tests/test_api.py` の既定頁Eアサーションから `name`/`dob` を除外、E

## 28. 管琁Eグアウトフローの簡素化！E025-08-23EE
- [x] 管琁E面の「ログアウト」Eタンを削除、E
- [x] 管琁Eート以外へ遷移したタイミングで自動ログアウト！EsessionStorage.adminLoggedIn` を削除E、E
  - 変更: `frontend/src/components/AdminLayout.tsx`EログアウトEタン削除EE
  - 変更: `frontend/src/App.tsx`E非管琁EートE移で自動ログアウト＋「問診画面に戻る」クリチE時にもE示削除EE

## 29. 管琁Eビをスクロール固定！EtickyEに変更EE025-08-23EE
- [x] 左側メニューめE`position: sticky; top: 0` とし、常にウィンドウ冁E表示、E
  - 変更: `frontend/src/components/AdminLayout.tsx`EEposition="sticky"`, `top={0}`, `maxH="100vh"`, `overflowY="auto"` をナビに付与！E
  - 変更: `frontend/src/App.tsx`E管琁Eートでは `overflowY` を親ボックスで作らず、ウィンドウスクロールに刁EEE

## 30. 管琁E面からフッター注意文を非表示EE025-08-23EE
- [x] 管琁E面では「本シスチEはローカルLLMを使用しており…」E注意文を非表示、E
  - 変更: `frontend/src/App.tsx` のフッター表示条件めE`!isChatPage && !isAdminPage` に変更、E

## 31. 管琁Eグインをモーダル化！E025-08-23EE
- [x] 患老E面から管琁E面へ遷移する際、画面冁EーダルでパスワードE力、E
  - 変更: `frontend/src/App.tsx` にログイン用モーダルを実裁EEチEーの「管琁E面」クリチEでモーダルを開き、E功後に `/admin/templates` へ遷移、E
  - 直接URLでのアクセス時E従来通り `/admin/login` へ誘導（ガード継続）、E

## 33. LLM 追加質問E質問文と回答Eアの永続化EE025-08-27EE
- [x] DB スキーマ拡張E`session_responses` に `question_text` 列を追加し、LLM 生Eの追加質問に限り提示した質問文を保存、E
- [x] 保存ロジチEE`SessionFSM` ぁE`pending_llm_questions` 生E時に `session.llm_question_texts` にマッピングを保持し、`save_session` ぁE`llm_*` 回答と紐付けて保存するよぁE更、E
- [x] 取得ロジチEE`db.get_session` で `llm_question_texts` を復允E、管琁E細 `GET /admin/sessions/{id}` のレスポンスに含める、E
- [x] ドキュメント更新E`docs/session_api.md` に保存仕様とレスポンス頁Eを追記、E

## 32. アプリのロゴ斁Eを変更EE025-08-23EE
- [x] ロゴ表示を「MonshinMate」E「問診メイト」に変更、E
  - 変更: `frontend/src/App.tsx` のヘッダーロゴ斁E、E
  - 変更: `frontend/index.html` の `<title>`、E

## 33. シスチE表示名E設定機EEE025-08-23EE
- [x] 管琁E面から「シスチE表示名」を編雁E能にし、患老E面のヘッダーに反映E管琁E面のヘッダーは固定文言「管琁E面」とし設定E影響を受けなぁE、E
  - 変更EバチEエンド！E `backend/app/db.py` に `app_settings` チEEブルと `save_app_settings` / `load_app_settings` を追加、E
  - 変更EバチEエンド！E `backend/app/main.py` に `GET/PUT /system/display-name` を追加E既定値は「Monshinクリニック」）、E
  - 変更Eフロント！E `frontend/src/pages/AdminSystemName.tsx` を追加EE劁E保存UIE、E
  - 変更Eフロント！E `frontend/src/components/AdminLayout.tsx` のメニューに「シスチE表示名」を追加、E
  - 変更Eフロント！E `frontend/src/App.tsx` で表示名を取得E購読し、患老E面のヘッダーに表示。設定保存時はカスタムイベントで即時反映、E
  - 変更E開発プロキシEE `frontend/vite.config.ts` に `/system` を追加し、E発時EAPI疎送E04を解消、E

## 34. フッターに小さく「問診メイト」を表示EE025-08-23EE
- [x] 管琁E面含め、フチEー左に小さくブランド名「問診メイト」を表示。患老E面のみ従来の注意文も併記、E
  - 変更: `frontend/src/App.tsx` フッター構造を調整EEText fontSize="xs"` で表示E、E

## 35. 管琁E面に使ぁEペEジを追加EE025-10-31EE
- [x] 管琁Eニューに「使ぁE」を追加し、基本皁E利用方法を画面上で確認できるようにした、E

## 36. 管琁E面セチEアチEE手頁Eの追加EE025-11-01EE
- [x] 管琁E面でのシスチE全体EセチEアチEE方法を説明するドキュメンチE`docs/admin_system_setup.md` を追加、E
- [x] 管琁Eニューの「使ぁE」EージぁE`docs/admin_system_setup.md` を参照するように変更、E

## 37. 初回アクセス時Eパスワード設定UIEE025-11-02EE
- [x] 管琁Eスワードが初期値のままの場合、ログイン前に新規パスワード設定モーダルを表示するようにした、E
- [x] フロンチE `frontend/src/App.tsx` に初回パスワード設定ロジチEとUIを追加、E
- [x] バックエンチE `GET /admin/password/status` と `POST /admin/password` を追加し、DB にパスワードを保存するよぁE更、E

## 38. チャチE画面での初期パスワード強制と TOTP 対応！E025-11-02EE
- [x] 患老Eの対話画面EE/chat`Eアクセス時、管琁Eスワードが初期設定EままならE画面でパスワード設定モーダルを強制表示EEfrontend/src/App.tsx`E、E
- [x] パスワード設定直後に Google Authenticator による TOTP 秘寁E作Eを推奨EER 表示ↁE桁コードE力E有効化）、E
- [x] 管琁EグインETOTP 忁E時の二段階目認証UIを追加EE/admin/login`→`/admin/login/totp`E、E
- [x] 「パスワードをお忘れですかE」かめETOTP を用ぁEリセチEEトークン発行E新PW確定）を実裁EE
- [x] 参EエンドEイントを `/admin/auth/status` に統一E旧 `/admin/password/status` は廁EE、E

## 39. パスワード設定後E Authenticator 有効化確認！E025-11-02EE
- [x] パスワードE設定またE変更直後に、Authenticator を有効にするかどぁE確認するダイアログを追加、E
- [x] Authenticator を有効化しなぁE合EパスワードEリセチEができなぁEを警告、E

## 40. 管琁E患老EEチEーでの LLM 接続状態表示EE025-11-03EE
- [x] 管琁E面ヘッダーの「問診画面に戻る」Eタンの左側に小さなバッジで LLM 接続状態を表示E接続OK=緑、エラー=赤、無効=灰E、E
- [x] 患老EEヘッダーでも「管琁E面」Eタンの左側に同バチEを表示、E
- [x] 疎通チェチEは「患老E名等E初期入力画面EEntryE」に戻ったときEみ実施し、結果は `llmStatusUpdated` イベントで吁E面へ伝播E不要な頻度の疎通を抑制E、E
- [x] 実裁E `frontend/src/utils/llmStatus.ts` 追加、`Entry.tsx` で `refreshLlmStatus()` を発火、`LlmStatusBadge`/`AdminLayout`/`AdminTemplates` はイベント購読に統一、E

## 41. LLM通信エラー時E自動フォールバックEE025-11-03EE
- [x] サマリ作EめE加質問生成で LLM 通信に失敗した場合、LLM を使わなぁEE琁E自動的に刁E替えるようにした、E
- [x] 追加質問生成中に通信エラーが発生した場合E追質問スチEプをスキチEEする、E

## 42. 管琁EEオフラインリセチEスクリプトの整備！E025-08-24EE
- [x] `backend/tools/reset_admin_password.py` を改修し、以下を確実に実施するよう統一:
  - [x] 管琁EEスワードE上書き！Ecryptでハッシュ保存！E
  - [x] `is_initial_password=1` の設宁E
  - [x] 二段階認証の完E無効化！Eis_totp_enabled=0`, `totp_mode='off'`, `totp_secret=NULL`EE
  - [x] 既存DBに不足するカラムEEis_initial_password`, `totp_mode`Eを自動追加E存在時E無視！E
  - [x] 管琁EE存在しなぁE合E自動作E
- [x] 運用ドキュメント！Edocs/admin_system_setup.md`Eにオフライン復旧手頁E追記、E

## 43. 監査ログ整備と確認手段EE025-08-24EE
- [x] `security` ロガーでの主要イベントE力！Ebackend/app/logs/security.log`、ローチEEションありEE
- [x] `audit_logs` チEEブルと SQLite トリガで、`users` チEEブルの重要E更新時に自動記録
- [x] パスワード更新・TOTP 状慁Eモード変更・初期admin作E・強制リセチEを監査対象に追加
- [x] 監査ダンプツール `backend/tools/audit_dump.py` を追加E直近N件の表示EE
- [x] 手頁EE `docs/admin_system_setup.md` に記載（開発向けEE

## 44. チEォルトテンプレのフリー入力E一部を「選択肢EE由記述」に変更EE025-08-24EE
- [x] チEォルトテンプレート（E診・再診EEぁE、E刁E自由記述頁Eを褁E選択＋E由記述に差し替え（主訴は自由記述のままE、E
  - 変更: `prior_treatments` を褁E選択（なぁE外用薬/冁E薬/注封E手衁Eリハビリ/そE他＋E由入力）、E
  - 変更: `past_diseases` を褁E選択（なぁE高血圧/糖尿痁E脂質異常痁E喘E/アトピー性皮膚炎/花粉症/蕁E疹/そE他＋E由入力）、E
  - 変更: `surgeries` を褁E選択（なぁE皮膚科関連手衁E整形外科手衁E腹部手衁E忁E手衁EそE他＋E由入力）、E
  - 変更: `current_medications` を褁E選択（なぁEスチEイド外用/抗菌薬/抗ヒスタミン薬/NSAIDs/免疫抑制薬/そE他＋E由入力）、E
  - 変更: `supplements_otc` を褁E選択（なぁEビタミン剤/漢方/鎮痛解熱薬/かゆみ止めE保湿剤/そE他＋E由入力）、E
  - 変更: `drug_allergies` を褁E選択（なぁEペニシリン系/セフェム系/マクロライド系/ニューキノロン系/NSAIDs/局所麻酁EそE仁E不EEE由入力）、E
  - 変更: `food_metal_allergies` を褁E選択（なぁE卵/乳/小麦/そE/落花甁EえE/かに/金属（ニチEル等！EそE仁E不EEE由入力）、E
  - 備老E 郵便番号/住所/電話番号は引き続き自由記述のまま、E
  - 実裁E `backend/app/main.py` の `on_startup()` で投Eする既定テンプレの頁E定義を更新、E

## 45. 問診チEプレ編雁E面の「問診頁Eを追加」Eタンを一覧下部へ移動！E025-11-03EE
- [x] 「問診頁Eを追加」Eタンを頁E一覧表の直下に配置し、最終行E下から新規頁Eを追加しやすくした、E
  - 変更: `frontend/src/pages/AdminTemplates.tsx` のボタン位置と斁Eを調整、E
  - ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`、E

## 46. TOTPシークレチE欠如時の自動無効化！E025-11-04EE
- [x] シークレチEが存在しなぁEEに `is_totp_enabled=1` の場合、ログイン時に自動的に二段階認証を無効化するよぁEした、E
  - 変更: `backend/app/db.py` の `get_totp_mode` はシークレチE未設定時に常に `'off'` を返すよう修正、E
  - 変更: `backend/app/main.py` の `admin_login` で不整合状態を検知ぁE`set_totp_status` により無効化、E
  - チEチE `backend/tests/test_admin.py` に再現チEトを追加、E
  - ドキュメント更新: `docs/admin_system_setup.md` に自動無効化E注意書きを追加、E

## 47. 二段階認証無効時EパスワードリセチE案EEE025-11-05EE
- [x] TOTP が無効の状態でパスワードリセチEペEジにアクセスすると、二段階認証入力ではなくシスチE初期化スクリプトの実行を案EするメチEージを表示、E
  - 変更: `frontend/src/pages/AdminPasswordReset.tsx`
  - 変更: `frontend/src/pages/AdminLogin.tsx`
  - ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`

## 48. オフラインリセチEスクリプトでのユーザーチEEブル列保証EE025-11-06EE
- [x] `backend/tools/reset_admin_password.py` の `ensure_users_table` ぁE`password_updated_at` と `totp_changed_at` カラムを既存DBに追加するよう修正、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`

## 49. TOTPシークレチE暗号化！E025-08-24EE
- [x] 共通キーによる暗号化を導Eし、`update_totp_secret` で暗号化保存、E
- [x] `get_user_by_username` で復号処琁E追加、E
- [x] 既存レコード暗号化スクリプト `backend/tools/encrypt_totp_secrets.py` を追加、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`.
- [x] チEチE `backend/tests/test_admin.py` で暗号化後E動作を確認、E

## 50. 管琁EEスワードE期化処琁EE安E性向上！E025-11-07EE
- [x] 旧 `app_settings.admin_password` を起動時に無視し削除するよう変更、E
- [x] `POST /admin/password` は現パスワードが環墁E定値と一致する場合Eみ受け付けるよぁE正、E
- [x] チEチE `backend/tests/test_admin.py` にレガシー設定無視とフラグ不整合時の拒否を追加、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`、E

## 51. 問診結果一覧の検索機E追加EE025-11-08EE
- [x] 管琁E面の問診結果一覧で患老E・生年月日・問診日篁Eによる検索を可能にした、E
- [x] 変更EバチEエンド！E `/admin/sessions` に検索用クエリパラメータを追加し、DBアクセス関数を拡張、E
- [x] 変更Eフロント！E `frontend/src/pages/AdminSessions.tsx` に検索フォームを追加、E
- [x] ドキュメント更新: `docs/session_api.md`, `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`、E

## 52. 空欁E答E「該当なし」保存！E025-11-09EE
- [x] 空欁E送信された回答を「該当なし」として保存するよぁE変更、E
  - 変更EバチEエンド！E `backend/app/structured_context.py` に回答正規化ロジチEを追加、E
  - 変更EバチEエンド！E `backend/app/main.py` でセチEョン作E時にも正規化を適用、E
  - チEチE `backend/tests/test_api.py` に空欁E答保存E確認テストを追加、E
  - ドキュメント更新: `docs/session_api.md`、E

## 53. 追加質問Eロンプトのアドバンスト編雁EEEE025-11-10EE
- [x] 管琁E面チEプレート設定にアドバンストモードを追加し、追加質問Eロンプトを編雁E能にした、E
- [x] プロンプトは `{max_questions}` プレースホルダを含み、LLMはJSON配Eで質問を返す仕様を説明、E
- [x] 初期値に戻すEタンを設置し、既存テンプレートにはチEォルトEロンプトを適用済み、E
- [x] エンドEイント追加: `GET/POST /questionnaires/{id}/followup-prompt`、E
- [x] チEチE `backend/tests/test_api.py` に設定反映の確認テストを追加、E

## 54. サマリー自動作E設定Eプロンプト位置調整EE025-11-11EE
- [x] 管琁E面チEプレート設定で、E診・再診それぞれのサマリープロンプト編雁EE該当チェチEボックスの直下に表示されるよぁE喁EE

## 55. サマリー生Eの有効設定反映EE025-11-12EE
- [x] サマリー作Eモードが無効な場合E `POST /sessions/{id}/finalize` が空斁EE要紁E返すよう修正、E
- [x] サマリー作Eモード有効時E要紁E成を確認するテストを追加、E
- [x] ドキュメント更新: `docs/session_api.md`、E

## 56. 追加質問判定時のフェチEエラー処琁E喁EE025-11-13EE
- [x] LLM 追質問E要否判定およE質問取得E際、HTTP エラーめEチEワーク例外が発生した場合にレビュー画面へフォールバックするようにした、E
- [x] 変更: `frontend/src/pages/LlmWait.tsx`, `frontend/src/pages/Questions.tsx`、E

## 57. チEEマカラー設定機EEE025-11-14EE
- [x] 管琁E面でUIのチEEマカラーを変更できるようにし、パスチEカラー10種のサンプルと任意EカラーコードE力に対応、E
- [x] 変更EバチEエンド！E `backend/app/main.py` に `GET/PUT /system/theme-color` を追加、E
- [x] 変更Eフロント！E `frontend/src/contexts/ThemeColorContext.tsx`, `frontend/src/theme/index.ts`, `frontend/src/pages/AdminTheme.tsx`, `frontend/src/components/AdminLayout.tsx`, `frontend/src/main.tsx`, `frontend/src/App.tsx`、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`、E

## 58. 管琁Eグイン失敗時のメチEージ簡略化！E025-11-15EE
- [x] 管琁E面へのログインでパスワードが誤ってぁE場合E応答を「パスワードが間違ってぁEす」に変更、E
- [x] 不要なパスワードリセチE案Eをログイン画面から削除、E
- [x] 変更: `backend/app/main.py`, `frontend/src/pages/AdminLogin.tsx`、E
- [x] チEト更新: `backend/tests/test_admin.py`、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`、E

## 59. 管琁Eグインを画面冁Eーダル化！E025-11-16EE
- [x] 患老E面の「管琁E面」Eタン押下時に、別ウィンドウではなくモーダルでログインフォームを表示し、E功後に `/admin/templates` へ遷移、E
- [x] 変更: `frontend/src/App.tsx`、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`、E

## 60. 二段階認証画面を同モーダル冁E表示EE025-11-16EE
- [x] パスワード送信後E二段階認証コードE力も同じモーダル冁E行えるよぁEした、E
- [x] 変更: `frontend/src/pages/AdminLogin.tsx`、E
- [x] ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`、E

## 61. 問診完亁EE確認画面を廁EEE025-11-17EE
- [x] Review 画面を削除し、質問終亁EE直接完亁E面へ遷移するよう変更、E
- [x] フロントエンドおよEドキュメントを更新、E

## 62. LLM通信失敗時のエラーモーダル表示EE025-11-18EE
- [x] LLMとの通信エラー冁Eを画面上部のモーダルで表示しつつ既存Eフォールバックを継続するよぁE更、E
- [x] 変更: `frontend/src/components/TopErrorModal.tsx`, `frontend/src/pages/LlmWait.tsx`, `frontend/src/pages/Questions.tsx`, `frontend/src/pages/Done.tsx`、E

## 63. LLM通信エラー惁Eの自動表示とサマリー追記！E025-11-19EE
- [x] エラーモーダルは10秒後に自動的に閉じるよぁEし、ユーザー操作が不要に、E
- [x] LLM通信エラー冁Eをサマリー末尾に追記し、問診結果DBから参Eできるようにした、E
- [x] 変更: `frontend/src/components/TopErrorModal.tsx`, `frontend/src/pages/LlmWait.tsx`, `frontend/src/pages/Questions.tsx`, `backend/app/main.py`、E

## 64. セキュリチEタブに「二段階認証を有効化」Eタンを追加EE025-08-27EE
- [x] 管琁E面のセキュリチEタブで、未有効時に明示皁E「二段階認証を有効化する」Eタンを表示、E
- [x] ボタン直下に「パスワードをリセチEするには二段階認証の有効化が忁Eであり推奨する」旨のメチEージを表示、E
- [x] 二段階認証が有効になって初めて「QRコードを表示」EタンめEパスワードをリセチE」Eタンが表示されるよぁE件刁Eを整琁EE
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminSecurity.tsx`、E

## 65. セチEョン開始時の旧チEEタ初期化と自動E力抑止EE025-11-20EE
- [x] Entry ペEジ表示時に旧セチEョン惁EめE`sessionStorage` から削除し、常に新しいセチEョンIDで問診を開始できるようにした、E
- [x] 患老EけE力フォームの `autoComplete` めE`off` に設定し、ブラウザの自動E力によるチEEタ混同を防止、E
- 変更: `frontend/src/pages/Entry.tsx`, `frontend/src/pages/QuestionnaireForm.tsx`, `frontend/src/pages/Questions.tsx`, `frontend/src/components/DateSelect.tsx`、E

## 66. TOTP有効化タイミングの修正EE025-11-21EE
- [x] `set_totp_mode` で `is_totp_enabled` をE動的に更新しなぁEぁEし、QRコード発行後にコードを検証して初めて有効化されるよう変更、E
- [x] モード変更のみでは有効化されなぁEとを確認するテストを追加、E
- [x] 変更: `backend/app/db.py`, `backend/tests/test_admin.py`, `docs/admin_system_setup.md`、E

## 67. 二段階認証無効化時のシークレチE削除EE025-11-22EE
- [x] 無効化すると登録済みのTOTPシークレチEを削除し、E有効化時に旧コードが利用されなぁEぁEした、E
  - 変更: `backend/app/db.py`, `backend/app/main.py`
  - チEチE `backend/tests/test_admin.py`
  - ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`

## 68. 追加質問E一括返却EE025-08-27EE
- [x] LLM への問い合わせを1度だけ行い、生成された追加質問をまとめて返す `next_questions` を追加、E
- [x] エンドEインチE`/sessions/{id}/llm-questions` は全ての質問を一括で返却するよう変更、E
- [x] ドキュメント更新: `docs/session_api.md`、E
- [x] チEト更新: `backend/tests/test_api.py`、E

## 69. セキュリチEタブETOTP無効化フロー見直し！E025-08-26EE
- [x] 二段階認証が有効な状態では、QRコードE再表示および再設定（E生EEEタンを非表示にした、E
- [x] 「二段階認証を無効化する」実行時に画面冁Eーダルで6桁コードE入力を忁E化。正しいコードE力時のみ無効化、E
- [x] バックエンチE`/admin/totp/disable` めETOTPコード忁Eに変更E検証ウィンドウ±1スチEプ）、E
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminSecurity.tsx`
- [x] 変更EバチEエンド！E `backend/app/main.py`
- [x] チEト更新: `backend/tests/test_admin.py`

## 70. 問診頁Eの補足説明E力機E追加EE025-11-23EE
- [x] 吁E診頁Eに任意E補足説明を設定できるようにした、E
- [x] 変更EバチEエンド！E `backend/app/main.py`
- [x] 変更Eフロントエンド！E `frontend/src/pages/QuestionnaireForm.tsx`, `frontend/src/pages/AdminTemplates.tsx`
- [x] チEト追加: `backend/tests/test_api.py`
- [x] ドキュメント更新: `docs/session_api.md`, `docs/plannedSystem.md`, `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`

## 71. 管琁E面からのパスワード変更とTOTP無効化！E025-11-24EE
- [x] セキュリチE画面に現在のパスワードを入力して更新するモーダルを追加、E
- [x] パスワード変更時に二段階認証をE動的に無効化するよぁEした、E
- [x] 変更EバチEエンド！E `backend/app/main.py`
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminSecurity.tsx`
- [x] チEト追加: `backend/tests/test_admin.py`
- [x] ドキュメント更新: `docs/session_api.md`, `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`

## 72. LLM追質問EセチEョンストレージ再利用EE025-11-25EE
- [x] `LlmWait` で取得した追加質問を `pending_llm_questions` として保存し、`Questions` ペEジで再利用するようにした、E
- [x] 質問を消費した際E `pending_llm_questions` を更新し、空になった場合Eみ `/llm-questions` をE呼び出すよぁE更、E
- [x] ドキュメント更新: `docs/session_api.md`、E

## 73. 褁E選択頁Eの自由記述チェチEボックス追加EE025-12-06EE
- [x] 褁E選択肢で自由入力を行う際、専用チェチEボックスを新設し、チェチE時EみチEストE力欁E有効化されるよう変更、E
- [x] 変更Eフロントエンド！E `frontend/src/pages/QuestionnaireForm.tsx`
- [x] ドキュメント更新: `docs/PlannedDesign.md`

## 74. プロンプト斁Eの改良EE025-12-07EE
- [x] 追加質問とサマリー生Eの既定Eロンプトを医療向けに詳細化、E
- [x] LLM 設定EシスチEプロンプトに医療問診支援向け斁Eを追加、E
- [x] 変更EバチEエンド！E `backend/app/llm_gateway.py`, `backend/app/main.py`, `backend/tests/test_api.py`
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminTemplates.tsx`
- [x] ドキュメント更新: `docs/LLMcommunication.md`, `docs/session_api.md`, `docs/implementation.md`

## 75. チEォルトテンプレートE性別関連頁E整琁EE025-12-08EE
- [x] 初診チEォルトテンプレートから性別質問を削除し、E褁EE力を解消、E
- [x] 妊娠・授乳の質問に対象性別を設定し、女性のみ表示されるよぁE更、E
- [x] 喫煙E飲酒E質問に自由記述欁E追加し、E択肢以外E回答を許容、E
- [x] 変更EバチEエンド！E `backend/app/main.py`, `backend/build/lib/app/main.py`
- [x] チEト更新: `backend/tests/test_api.py`
- [x] ドキュメント更新: `docs/implementation.md`

## 76. ラチEーGUI録音エラーの修正EE025-12-09EE
- [x] 例外変数がガーベジコレクトされてしまぁEラーメチEージが表示できなかった不E合を修正、E
- [x] 変更: `wrapper/app/gui.py`

## 77. 単一選択E力E廁EEE025-12-10EE
- [x] 単一選択E力方式を廁Eし、既存E単一選択頁Eを褁E選択に統一、E
- [x] 変更EバチEエンド！E `backend/app/main.py`, `backend/app/db.py`, `backend/app/validator.py`
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminTemplates.tsx`, `frontend/src/pages/QuestionnaireForm.tsx`
- [x] チEト更新: `backend/tests/test_api.py`
- [x] ドキュメント更新: `docs/PlannedDesign.md`, `docs/implementation.md`

## 78. LLMスチEEタス表示の明確化！E025-12-10EE
- [x] スチEEタスバッジの表示斁Eを調整し、`status === 'ok'` でめE`base_url` が未設定E場合E「LLM有効(ローカル)」と表示するように変更E従来は「LLM接続済」と表示され紛らわしかった）、E
- [x] 変更Eフロントエンド！E `frontend/src/components/LlmStatusBadge.tsx`

## 79. LLM設定保存後にスチEEタス更新EE025-12-10EE
- [x] LLM設定画面で保存E功時に `refreshLlmStatus()` を呼び出し、右上EスチEEタスバッジへ最新状態を即時反映、E
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminLlm.tsx`

## 80. LLM疎通テストE厳格化！E025-12-10EE
- [x] `/llm/settings/test` で、`enabled` かつ `base_url` と `model` が指定されてぁEぁE合E `ng` を返すように変更、E
- [x] `test_connection()` はまずモチE一覧の取得を行い、E択モチEが含まれる場合に `ok` と判定！Ellama: `/api/tags`、LM Studio: `/v1/models`E、E
- [x] チャチEによる疎通確認E廁Eし、タイムアウトE影響を避けた、E
- [x] `/llm/settings` 保存時の疎通テストE `base_url` 持E時のみ実行（空の場合E保存可能だが、スチEEタスは `ng`E、E
- [x] 変更EバチEエンド！E `backend/app/llm_gateway.py`, `backend/app/main.py`

## 81. LLM設定E忁E頁EとUI制御EE025-12-10EE
- [x] LLM有効時EモチE名が忁E（未入力で保存不可、E00E、E
- [x] 管琁E面に「LLMを使用する」チェチEボックスを追加し、オフ時は吁E定を一括で非活性化、E
- [x] 変更EバチEエンド！E `backend/app/main.py`
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminLlm.tsx`

## 82. LLM未使用時EUIとバッジ斁EEE025-12-10EE
- [x] 「LLMを使用する」チェチEボックスをフォーム最上部へ移動、E
- [x] LLM未使用時Eプロバイダ選択欁EEllama/LM StudioEを非表示、E
- [x] 右上EスチEEタスバッジの無効ラベルを「LLM未使用」に変更、E
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminLlm.tsx`, `frontend/src/components/LlmStatusBadge.tsx`

## 83. 問診結果ダウンロード機E追加EE025-12-11EE
- [x] 管琁E面の問診結果一覧にPDF/Markdown/CSVダウンロード用アイコンを追加、E
- [x] 変更EバチEエンド！E `backend/app/main.py`, `backend/pyproject.toml`
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminSessions.tsx`
- [x] チEト追加: `backend/tests/test_api.py`
- [x] ドキュメント更新: `docs/admin_system_setup.md`, `frontend/public/docs/admin_system_setup.md`, `docs/implementation.md`

## 84. 管琁E面使ぁEドキュメントE差し替え！E025-12-12EE
- [x] 日常操作向けE `docs/admin_user_manual.md` を追加し、管琁Eニューの「使ぁE」Eージで表示するよう変更、E
- [x] `docs/admin_system_setup.md` から「使ぁEペEジ」に関する記述を修正、E
- [x] 変更Eフロントエンド！E `frontend/src/pages/AdminManual.tsx`
- [x] ドキュメント追加: `frontend/public/docs/admin_user_manual.md`
