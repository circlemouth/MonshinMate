# MonshinMate フロントエンドUI 構築設計書（Minimal 版）

> **注記**：本システムはローカルLLMを使用しており、外部へ情報が送信されることはありません。すべての主要画面のフッターに本注意書きを表示する。

---

## 0. 目的 / スコープ
- 目的：患者が最小限の入力で問診を完了し、LLMの追加質問で不足情報を補完できるUIを提供する。
- スコープ：患者向け画面（基本情報＋受診種別→ベース問診→LLM追加質問→最終確認→完了）、および管理画面（問診テンプレート設定、LLM接続設定、簡易プレビュー）。
- 非スコープ：禁忌/赤旗、辞書正規化、同意画面、重複照合/ID発行、ルールベース追質問、緊急分岐。

---

## 1. 情報アーキテクチャ（IA）/ 画面一覧

### 患者向け
1. **/ (Entry)**
   - 基本情報入力（患者名・生年月日）＋受診種別の選択（初診/再診）
   - 右上：管理画面へのボタン（/admin へ。/admin はテンプレート一覧へリダイレクト）
2. （統合済み）受診種別は Entry に統合（本セクションは廃止）
3. **/questionnaire**
   - ベース問診フォーム（テンプレートに従う）
   - 送信後、LLMの追加質問フェーズへ遷移
4. **/questions**
   - 追加質問（LLM生成）を 1問ずつ or 複数まとめて表示・回答
   - 追加質問がなくなった/上限到達/手動終了で次へ
5. **/review**
   - 全回答の一覧表示・その場修正・確定
6. **/done**
   - 完了表示（印刷/共有は任意）

### 管理者向け
1. **/admin/login**
   - 管理者ログイン（メール + パスワード / またはID + パスワード）
2. **/admin/templates**
   - 問診テンプレート一覧・新規作成・編集・複製・削除
3. **/admin/templates/:id**
   - テンプレート編集（項目ごとの初診/再診チェック、項目CRUD、プレビュー）
4. **/admin/sessions**
   - 問診結果一覧
5. **/admin/sessions/:id**
   - セッションの質問と回答の詳細表示
6. **/admin/llm**
   - LLM接続設定（ローカルLLM接続に必要な項目）

---

## 2. 共通レイアウト / ナビゲーション
- **ヘッダー**：左にロゴ（MonshinMate）、右に「管理画面」ボタン（常時表示、/adminへ。/admin はテンプレート一覧へリダイレクト）。
- **フッター**：`本システムはローカルLLMを使用しており、外部へ情報が送信されることはありません。` を小さめに常時表示。
- **ブレッドクラム**：患者向けは非表示（ステップナビで代替）。管理画面のみ簡易パンくず。
- **ステップナビ（患者向け）**：Entry → 問診 → 追加質問 → 確認 → 完了（現在位置を強調）。

---

## 3. 画面詳細（患者向け）

### 3.1 Entry（/）
- **フォーム項目**
  - 氏名（必須、テキスト）
  - 生年月日（必須、日付ピッカー。YYYY-MM-DD）
- 受診種別（必須、初診/再診のラジオ）
- **ボタン**：次へ（セッション作成→/questionnaire へ）
- **バリデーション**
  - 氏名：1〜64文字、両端空白除去
  - 生年月日：過去日付のみ、妥当な日付形式
- **UIメモ**：入力ミスはフィールド下に赤字で1文提示。Enterで次へ可。

### 3.2 Visit Type（統合済み）
本セクションは Entry に統合済み（受診種別は Entry で選択）。

### 3.3 Questionnaire（/questionnaire）
- **表示**：選択した種別に紐づくテンプレートの項目
  - 入力型：単一選択、複数選択、数値、日付、テキスト（複数行）
  - 任意の軽い条件分岐は即時反映（例：施術希望=あり → 施術関連項目を表示）
- **アクション**：
  - 一時保存（ローカル：sessionStorage）
  - 送信（/questions へ）
- **バリデーション**：必須、型、範囲（最小限）
- **UX**：長いフォームはセクション化、セクション間はアコーディオンで展開/折畳み。

### 3.4 LLM 追加質問（/questions）
- **表示形式**
  - 1問ずつダイアログ（モーダル）で提示、回答後に次へ
  - または**複数カード**を縦に提示し、まとめて回答→送信（上限N件）
- **ヘッダー**：`不足情報の確認`（説明：不足/曖昧な点のみを最小限質問します）
- **アクション**：回答送信／今回は終了する（任意）
- **状態**：進行インジケータ（例：2/3 質問）
- **終了条件**：LLM結果が0件／上限到達／ユーザー手動終了

### 3.5 Review（/review）
- **内容**：全回答（ベース問診＋追加質問）を一覧表示、各項目は**その場編集**可
- **アクション**：確定送信（/done へ）／戻る（/questions）
- **UI**：セクションごとに編集リンク、編集はインライン

### 3.6 Done（/done）
- **表示**：完了メッセージ、受付に提示するための要約（テキスト/Markdown）
- **任意**：印刷、共有（クリップボードコピー）

---

## 4. 画面詳細（管理者向け）

### 4.1 Login（/admin/login）
- **フォーム**：ID/メール、パスワード
- **バリデーション**：空欄禁止
- **エラー**：認証失敗時は汎用メッセージ（IDまたはパスワードが正しくありません）

### 4.2 Templates 一覧（/admin/templates）
- **表**：テンプレート名、最終更新、ステータス（公開/下書き）
- **操作**：新規作成、編集、複製、削除（削除は確認ダイアログ）

### 4.3 Template 編集（/admin/templates/:id）
- **タブ**：初診 / 再診
- **項目リスト**：
  - 各項目：`項目ID`、`表示名`、`入力型`、`必須`、`説明文`、`条件表示（任意）`
  - 入力型：単一選択 / 複数選択 / 数値 / 日付 / テキスト
  - 選択肢（入力型が選択のとき）
- **操作**：項目の追加/並替/削除、プレビュー（右パネル）
- **検証**：重複IDの禁止、必須項目の不足チェック
- **保存**：ドラフト保存と公開（公開は閲覧側に反映）

### 4.4 Sessions 一覧（/admin/sessions）
- **表**：患者名、生年月日、受診種別、確定日時
- **操作**：患者名をクリックで詳細へ遷移

### 4.5 Session 詳細（/admin/sessions/:id）
- **内容**：各項目の質問と回答
- **備考**：テンプレート情報からラベルを取得して表示

### 4.6 LLM 接続設定（/admin/llm）
- **項目（例）**：
  - ランタイム種別：`Local`（固定表記）
  - 接続方式：`HTTP` / `CLI` / `Library`（いずれか運用に合わせて）
  - エンドポイント/モデル名/コンテキストサイズ上限
  - 追加質問の上限 N、1セッション最大ターン数、応答タイムアウト秒
  - 同時実行上限（キュー制御のためUIで案内のみ）
- **テストボタン**：疎通確認→成功/失敗の結果とログを表示
- **注意**：画面ヘッダーに**「ローカルLLM利用・外部送信なし」**の再掲

---

## 5. 主要コンポーネント設計（提案）

### 5.1 フォーム系
- `TextField`, `DateField`, `NumberField`, `Select`, `MultiSelect`, `Textarea`
- 共通Props：`value`, `onChange`, `required`, `error`, `hint`, `disabled`

### 5.2 問診レンダラ
- `QuestionRenderer`
  - 入力：`items: QuestionItem[]`（テンプレートの配列）
  - 出力：`{ itemId: value }` の辞書
  - 条件表示ロジックを内部で解決

### 5.3 追加質問UI
- `AdditionalQuestionModal` / `AdditionalQuestionList`
  - 入力：`questions: LlmQuestion[]`
  - 送信時に `{ id, answer }[]` を返す

### 5.4 レビュー/要約
- `ReviewTable`
  - 入力：すべての回答
  - インライン編集対応
- `SummaryBlock`
  - 入力：回答
  - 出力：印刷用テキスト/Markdown（フロント側で整形）

### 5.5 管理UI
- `TemplateList`, `TemplateEditor`, `TemplateItemForm`
- `LlmSettingsForm`

---

## 6. ルーティング / ガード
- ルート一覧は §1 に準拠。
- **ガード**：
  - `/questionnaire` は `session_id` が未作成なら `/` へ（Entry にて作成）
  - `/questions` は問診送信済が前提
  - `/review` は LLM 追加質問フェーズ完了が前提（またはスキップ）
  - 管理配下は認証必須（未認証は `/admin/login` へ）

---

## 7. 状態管理 / 永続化
- 患者回答は **sessionStorage** へドラフト保存（タブ閉じ誤爆対策）。
- 画面遷移時に都度バックエンドAPIへ保存（ネット障害時は再試行キュー）。
- 追加質問の進行状況（現在のインデックス、残数）を Store で管理。

---

## 8. バリデーション / エラーメッセージ（最小）
- 必須：未入力の場合は「この項目は必須です」。
- 型：数値/日付の形式誤りは「形式が正しくありません」。
- 範囲：数値範囲外は「範囲外の値です」。
- API 失敗：上部にトースト表示「通信に失敗しました。時間をおいて再度お試しください。」

---

## 9. アクセシビリティ / UX 配慮
- すべての入力にラベル、必須アスタリスク、aria-invalid 付与。
- キーボード操作（Tab順）、Enterで次へ、Escでモーダル閉。
- スマホ配慮（タップ領域44px、日付ピッカーはOSネイティブ優先）。

---

## 10. レスポンシブ / デザインガイド
- **ブレークポイント**：`<600`, `600–960`, `960–1280`, `>1280`
- **テーマトークン（院内カラー）**：
  - Primary: `#1d3d5e`
  - Accent: `#b8d0ed`
  - Text: `#1c1c1c`
  - Background: `#f9f9f9`
- ボタンサイズ、フォーム間隔（8/16/24px スケール）を標準化。

---

## 11. ローディング / 空状態 / トースト
- 送信中はボタンを `loading` に、フォームは disabled。
- 空状態：テンプレが未設定の場合、管理画面へ誘導するプレースホルダを表示。
- 成功/失敗はトースト（画面右上）。

---

## 12. 管理者機能の詳細仕様
- **テンプレ項目の型**：`text`, `multi`, `yesno`, `date`（4種。`date`は年・月・日をプルダウン選択）。
- **条件表示**：`when: { itemId, operator, value }[]`（ANDで評価）
- **公開/下書き**：公開のみ患者側に配信。編集はドラフトで行い、公開で差替。
- **プレビュー**：右パネルに患者画面の疑似レンダリング。種別切替可。
- **LLM 設定保存**：保存時に疎通テストを任意実行、結果を画面表示。

---

## 13. フロント-バックエンド I/F（UI視点の契約）
- `GET /questionnaires?visitType=initial|followup` → QuestionItem[]
- `POST /sessions` → { sessionId }
- `POST /sessions/:id/answers`（ベース問診）→ { ok }
- `POST /sessions/:id/llm-questions` → LlmQuestion[]
- `POST /sessions/:id/llm-answers` → { ok, remaining }
- `POST /sessions/:id/finalize` → { summaryText, allAnswers }
- 管理系：`GET/POST /admin/templates`, `GET/PUT /admin/templates/:id`, `GET/PUT /admin/llm`

> 注：API 名は暫定。最終はバックエンド設計書に合わせる。

---

## 14. 計測 / ログ（フロント）
- 各ステップの所要時間、LLM フェーズの質問回数、離脱地点。
- 障害計測：API失敗率、再試行回数。

---

## 15. テスト観点（UI）
- E2E：初診/再診それぞれで、入力→追加質問→確認→完了。
- 異常：未入力、型不正、ネット断（再試行/ドラフト復帰）。
- 管理：テンプレCRUD、公開切替、LLM疎通テストの表示。

---

## 16. 文言・マイクロコピー（例）
- 追加質問画面タイトル：`不足情報の確認`
- サブ：`不足や曖昧な点のみ、必要最小限の質問を行います。`
- フッター：`本システムはローカルLLMを使用しており、外部へ情報が送信されることはありません。`

---

## 17. 実装順（推奨）
1) ルーティング骨格 & 共通レイアウト
2) Entry / VisitType / Questionnaire
3) LLM 追加質問画面（モーダル or リスト）
4) Review / Done
5) 管理：Login / Templates / Sessions / LLM
6) ドラフト保存・再試行キューなどの改善

---

## 付録：主な型（UI想定）
```ts
// QuestionItem（テンプレ側）
interface QuestionItem {
  id: string;
  label: string;
  inputType: 'text' | 'multi' | 'yesno' | 'date';
  required?: boolean;
  description?: string;
  options?: { value: string; label: string }[]; // single/multi
  when?: { itemId: string; operator: 'eq' | 'ne' | 'in' | 'nin'; value: any }[];
}

// LLM 追加質問（フロント側）
interface LlmQuestion {
  id: string;            // new-xxx など
  text: string;          // 質問文
  expectedInputType: 'text' | 'multi' | 'yesno' | 'date';
  options?: { value: string; label: string }[];
  priority?: number;     // 低いほど高優先
}
```

---

以上。
