# 管理画面の使い方

本書は、日常の運用で管理画面を利用するための基本的な操作方法を説明します。

## 1. ログイン
1. 患者画面右上の「管理画面」ボタンを押します。
2. 管理者パスワードを入力してログインしてください。
   - 初期パスワードのままの場合は、新しいパスワードの設定が求められます。

### 操作時の通知について
- 各ページで保存やエラーが発生した際は画面右上に統一デザインの通知が表示され、必要に応じて「再試行」などの操作ボタンを押せます。
- 保存処理やモデル一覧取得など継続して参照したい結果はページ内のステータスバナーにも並びます。疎通テストの手動実行結果は通知のみで確認できます。
- 管理者としてログイン中に問診が完了すると、外観・通知設定で OS 標準通知を有効にしている場合はブラウザのデスクトップ通知でもお知らせされます。
  - 有効化すると初回にブラウザから通知許可を求めるトーストが表示されます。許可するとバックグラウンドにいる場合も OS 標準の通知が届きます。
  - 通知の有効/無効は端末（ブラウザ）ごとに保存されます。他の端末やブラウザには影響しません。
- 無効のままでも画面右上の通知で完了を確認でき、通知の「問診結果を確認」ボタンから一覧画面を開けます。

## 2. メイン画面（ダッシュボード）の確認ポイント
- ログイン後は左メニューの「メイン」が自動的に開きます。ここでは初診・再診を問わず最新の問診データをまとめて確認できます。
- 画面上部の表には、問診セッション（初診/再診）の最新10件が表示されます。
  - 各行には患者名・受診種別・問診日時が並び、行をクリックすると詳細画面に遷移します。
  - 「出力」ボタンから PDF / Markdown / CSV を個別に出力できます。Markdown はワンクリックでクリップボードにコピーされます。
  - 10件を超える履歴や検索を行いたい場合は、左メニューの「問診結果一覧」を利用してください。
- 表の下には以下の情報カードが並びます。
  - **使用中テンプレート**: 現在登録されているテンプレートIDと、初診/再診で利用できるかどうか、既定テンプレートIDが確認できます。
  - **データベース**: CouchDB を利用中か、SQLite を利用中か、エラーが発生していないかを色付きのタグで表示します。
  - **LLM**: 最新の通信状況（疎通良好/接続エラー/確認待ち/無効）と、設定中のプロバイダ名・モデル名・接続先URLを表示します。
    - 状態は管理者ログイン直後や疎通テスト、実際の LLM 呼び出しが完了したタイミングで自動更新されます。
    - ツールチップでは直近の更新日時と結果の詳細を確認できます。赤表示の場合は設定内容を確認してください。

## 3. 外観・通知設定の変更
1. 左メニューの「外観・通知設定」を開きます。
2. 表示名・メッセージ・ブランドカラー・ロゴ・通知設定の各セクションを必要に応じて編集します。
3. 表示名・メッセージ・カラー・ロゴは入力後数秒以内に自動保存され、患者画面と管理画面へ即時反映されます。通知設定は端末（ブラウザ）ごとに保存され、初期状態では無効です。

### 3-1. 表示名とメッセージ
- システム表示名は患者向け画面と管理画面で共通して利用されます。未入力の場合は既定値（問診メイト）が表示されます。
- 表示名が長い場合でもヘッダー内で自動的にフォントサイズが調整され、一行表示を保ちます。
- 「問診開始画面のメッセージ」「完了画面のメッセージ」はそれぞれ患者画面の案内文です。内容を変更すると自動保存され、即座に反映されます。

### 3-2. ブランドカラー
- パレットから既定の色を選ぶか、カラーピッカーで任意の16進カラーコードを指定できます。
- 変更すると自動で保存され、主要ボタンやアクセントの色がまとめて更新されます。

### 3-3. ロゴ / アイコン
1. 「クリニックのロゴ/アイコン」で画像ファイルを選択します。PNG/JPEG など、一般的なフォーマットを利用できます。
2. アップロードが成功すると「表示範囲を調整」ボタンが利用できます。ボタンを押すとモーダルが開き、青い枠をドラッグして表示範囲を調整できます。
3. ファイル名に空白や日本語が含まれていても自動的に安全な名称へ変換されるため、特別な事前調整は不要です。
4. モーダル内では数値入力欄や「全体」「正方形」ボタンも利用できます。モーダルを閉じても調整内容は自動保存され、数秒以内に患者画面ヘッダーや管理画面に反映されます。

### 3-4. 通知設定
- 「OS標準通知（ブラウザ通知）」のスイッチで問診完了時にデスクトップ通知を表示するか切り替えられます。設定は端末ごとに保持され、既定ではオフです。
- 有効化すると通知許可を促す案内が表示され、ブラウザ上で許可した場合のみ OS 標準の通知が届きます。ほかの端末には影響しません。
- 無効化しても画面右上のトースト通知は引き続き表示されます。ブラウザ通知が不要な運用時に活用してください。

## 4. 問診テンプレートの管理
1. 左メニューの「テンプレート」を開きます。
2. テンプレートを作成・編集し、必要に応じて問診項目を追加します。
   - 各項目には画像を添付できます。アップロードした画像は設定画面でプレビューされ、患者画面では質問と補足説明の下に大きく表示されます。
     - プレビュー画像をクリックするとモーダルで拡大表示されます。
     - 「画像を削除」ボタンを押すと確認ダイアログが表示され、承認後に削除されます。
     - 画像を設定した項目は項目一覧のラベル右側に画像アイコンが表示されます。
   - 患者基本情報（氏名・よみがな・住所・電話番号など）は固定UIで必須入力され、テンプレートの項目一覧には表示されません。
   - 選択肢ごとに条件分岐の追加入力欄を設定でき、特定の回答時のみ表示される追加質問を最大2階層まで追加できます。
     - 各選択肢の右側に表示される「？」アイコンにマウスを乗せると「追加質問を追加」の案内が現れ、クリックで編集モーダルが開きます。モーダルを開いた直後から新しい追加質問の入力欄が表示されるため、すぐに内容を編集できます。
     - 問診項目一覧に表示された追加質問をクリックすると、該当する追加質問を編集するモーダルが開きます。
   - 患者画面では条件を満たした場合に通常の質問としてその場に差し込まれ、特別な表示は行われません。
   - 追加質問を設定した選択肢には「枝」マークが表示され、項目一覧では追加質問が一段下げて表示されます。
   - 入力方法としてスライドバーを選択でき、最小値と最大値を設定可能です（既定は0〜10）。
   - 「性別で表示を制限」のチェックボックスをオンにすると、性別のプッシュボタンが表示されます。ラベルは「男性のみに質問」「女性のみに質問」となり、どちらかを選択して対象性別を指定できます。
   - 「年齢で表示を制限」をオンにすると、年齢範囲スライダーで表示対象の年齢帯を設定できます。スライダーは表示範囲の横幅の 2/3 で中央揃えで表示されます。患者の情報が条件に合致しない場合、その質問は表示されません。
3. 右上の「プレビュー」で患者画面での表示を確認できます。

### 4-1. テンプレート一覧の操作
- 一覧表の各行では以下の操作ボタンが利用できます。
  - **複製**: 既存テンプレートを新しいIDでコピーし、複製直後に編集画面へ切り替わります。
  - **リセット**: 標準テンプレート（ID:`default`）の行にのみ表示され、初期状態の内容へ戻します。
  - **名称変更**: 標準テンプレート以外の行で表示され、テンプレートIDを変更します。関連するサマリープロンプトや既定テンプレート設定も自動的に更新されます。
  - **削除**: 標準テンプレート以外の行で表示され、テンプレートと紐づく設定を完全に削除します。
- 標準テンプレートは削除・名称変更できません。編集内容を破棄したい場合は「リセット」を利用してください。

## 5. LLM 設定
1. 左メニューの「LLM設定」を開き、利用するプロバイダや接続先を設定します。
2. 設定保存時に自動で疎通テストが行われ、結果が通信状況として記録されます。
3. 追質問やサマリ作成を利用する場合は、この設定が有効である必要があります。
4. モデル名の入力欄右側にある「疎通テストを実行」で手動テストすると、結果は画面右上の通知で確認できます。`ollama` / `lm_studio` / `openai` など一部プロバイダでは「使用可能なモデル一覧を取得」ボタンが表示され、現在入力済みの `project_id` やアップロード済みの `service_account_json`（サービスアカウント JSON キーファイル）を一時的に API へ送り候補一覧を取得できます。`gcp_vertex`（Google Cloud Vertex AI）は一覧 API が制限されているためボタン・プルダウンが表示されず、モデル名を直接入力して疎通テストのみで確認します。
5. 「Google Cloud Vertex AI」プロバイダは常に選択肢として表示され、プロジェクトID・ロケーション・サービスアカウント JSON ファイルなどの入力欄が自動的に追加されます。サービスアカウントの JSON キーはファイルをアップロードするか、`GOOGLE_APPLICATION_CREDENTIALS` などの ADC を利用して認証してください。

## 6. 問診結果の確認
1. 左メニューの「問診結果」で送信済みセッションを確認できます。
2. 各行のアイコンから PDF / Markdown / CSV 形式で結果をダウンロードできます。
   - PDF は患者情報・質問・追質問を罫線付きのフォームとして配置し、紙の問診票に近いレイアウトで出力されます。
   - Markdown は患者情報（氏名・よみがな・生年月日・住所・電話番号など）を冒頭に整理した形式で出力し、YES/NO形式の回答も「はい」「いいえ」で表示されます。
   - 管理メニューの「PDFレイアウト」設定から、必要に応じて従来のシンプルなレイアウト（レガシー）へ切り替えできます。

## 7. データベース/LLM の稼働状況表示
- 「メイン」画面のカードで、現在利用中のデータベース種別・LLM疎通状態・モデル名を一目で確認できます。
  - 緑「DB:CouchDB」: CouchDB に接続できています。
  - 青「DB:SQLite」: CouchDB 未使用で SQLite を利用しています。
  - 赤「DB:接続エラー」: データベースに接続できていません。
  - LLM カードでは疎通状態（疎通良好/接続エラー/確認待ち/無効）と設定中のモデル名・接続先が表示されます。
- 画面上部のヘッダーにも従来通りバッジが表示され、どのページにいても状態を確認できます。バッジにマウスを乗せると最新の確認時刻と結果が表示されます。

## 8. さらに詳しい情報
システム全体のセットアップ手順やトラブルシューティングは [admin_system_setup.md](/docs/admin_system_setup.md) を参照してください。


## 9. 設定と問診データのバックアップ
- **テンプレート設定のエクスポート/インポート**
  - 「テンプレート」画面下部のカードから、テンプレート・各種プロンプト・LLM設定・ブランド設定・項目画像をまとめてダウンロードできます。
  - パスワードを指定すると暗号化された JSON ファイルとして出力され、同じパスワードを指定してインポートできます。
  - インポート時は「既存に上書き（merge）」または「入れ替え（replace）」を選択できます。入れ替えは現在のテンプレートと画像が全て削除されるためご注意ください。
- **問診データのエクスポート/インポート**
  - 「問診結果」画面上部にエクスポート/インポート用のカードが追加されています。
  - 選択中のセッションがあればその分のみ、選択が無ければ検索結果に表示されている全件を JSON 形式でダウンロードできます。こちらも任意のパスワードで暗号化可能です。
  - インポート時は既存データに追加（merge）するか、全件入れ替えるか（replace）を選択してください。入れ替えを選ぶと保存済みの問診データが削除されるため、事前にバックアップを取得してから実施してください。

## 10. API連携とChrome拡張機能
1. 左メニューの「API連携」から専用ページにアクセスします。
   - ここでは API キー（16文字以上）を新規に保存・削除できます。保存すると自動的に `patient_summary_api_key_hash` が更新され、古いキーは無効化される点に注意してください。
   - 「エンドポイント」「APIキー送信ヘッダー」の表示欄で、Chrome拡張機能に入力する値をコピーできます。ヘッダー名は `X-MonshinMate-Api-Key` です。
   - 画面下部に表示される URL は `POST /patient-summary`。拡張機能・外部アプリがこの URI に `patient_name`/`dob` を送り、Markdown を受け取る仕組みです。
2. 拡張機能のコードは `extensions/patient-summary` に収めてあり、Chrome の拡張機能ページ（`chrome://extensions/`）で「パッケージ化されていない拡張機能を読み込む」からフォルダを選択すれば動作します。
3. 拡張機能の設定項目
   - **APIエンドポイント**: 管理画面で表示される `/patient-summary` の URL をそのまま貼り付けます。
   - **APIキー**: 上記の API キーを入力。保存ボタンで Chrome ストレージに保持され、取得ボタンを押すと自動的に送信されます。
   - **患者名 / 生年月日の XPath**: DOM 上で値が表示される要素の XML Path（開発者ツールの右クリック → Copy XPath）を設定します。生年月日は西暦・スラッシュ区切り・和暦・`R5.04.01` のような表記にも対応して自動整形されます。
4. 拡張機能の「最新問診を取得」ボタンを押すと、設定済みの XPath から患者情報を取得し、API を呼び出します。正常終了時は Markdown をクリップボードへコピーし、OS 標準通知（許可時）で完了を知らせます。
5. 取得に失敗する主な原因
   - XPath が間違っている（取得値が空になる）。
   - APIキーが未設定、または誤っている。管理画面で再設定した後、拡張機能にも再入力してください。
   - 該当患者の確定済み問診が存在しない（サーバーは最新の `completion_status='finalized'` セッションのみ返します）。
6. 詳細な手順や補足は `docs/chrome_extension.md` を参照してください。
