# Chrome拡張「MonshinMate 問診取得」

この拡張機能は、管理画面で公開された `POST /patient-summary` API を呼び出し、最新の問診を Markdown で取得してクリップボードへコピーします。以下の手順で構成・利用します。

## 1. インストール
1. Chrome（または Chromium 系ブラウザ）で `chrome://extensions/` を開き、右上の「デベロッパーモード」を有効化します。
2. 「パッケージ化されていない拡張機能を読み込む」をクリックし、リポジトリ内 `extensions/patient-summary` フォルダを選択します。
3. 拡張機能のアイコンがツールバーに表示されます。クリックするとポップアップが開きます。

## 2. 設定項目と API 連携
- **APIエンドポイント**: 管理画面「API連携」で確認できる URL（たとえば `https://clinic.example.com/patient-summary`）を登録します。
- **APIキー**: 同じ画面で保存した API キーをそのまま入力します。保存ボタンで Chrome ストレージへ保存され、次回以降は自動的に読み込まれます。
- **XPath（患者名 / 生年月日）**: DOM 上の要素に対して、開発者ツールで右クリック → Copy → Copy XPath を選び、該当の XPath を貼り付けます。複数候補がある場合は最も安定したものを選びます。
- **保存 / 取得**: [保存]ボタンで設定を保持し、[最新問診を取得]を押すと XPath で抽出された値を `POST /patient-summary` へ送信します。

## 3. データ取得の流れ
1. ポップアップ経由でアクティブタブの DOM から `patient_name` / `dob` を XPath で取得します。
2. `dob` は以下の形式を自動整形します。
   - `YYYY-MM-DD`, `YYYY/MM/DD`, `YYYY.MM.DD`, `YYYY年MM月DD日`
   - 西暦（`2019/4/10` など）および和暦（`令和5年4月10日` / `R5.04.10` / `平成10/11/12`）にも対応。
   - 処理できない形式はトリムした文字列をそのまま送信します。
3. 管理画面で表示されたヘッダー `X-MonshinMate-Api-Key` に API キーをセットし、JSON ボディ `{ patient_name, dob }` を `POST` します。
4. 成功するとサーバーが Markdown を返すので、拡張機能がクリップボードへコピーします。
5. 処理完了時に OS 標準の通知（許可済みであれば）を表示し、ポップアップ内ステータスも更新します。

## 4. トラブルシューティング
- **XPath が正しくない**: ステータス欄に「取得できませんでした」と表示される場合は XPath を再確認し、`document.evaluate` で値が取れるか調べてください。
- **APIキーエラー**: 401/403 系のエラーが出たときは管理画面で API キーを再生成し、Chrome 拡張にも同じキーを貼り付けて保存します。
- **セッションが見つからない**: 404 の場合は該当の患者名＋生年月日の確定済みデータがないという意味です。該当患者の最新問診が `completion_status='finalized'` になっているか確認してください。

## 5. 実装と構成
- ソースコードは `extensions/patient-summary` に配置しています。
  - `manifest.json`: Manifest V3 で `storage`, `scripting`, `tabs` を使用。
  - `popup.html` / `popup.js`: ポップアップ UI とロジック。
- 拡張機能は API 設定を Chrome ストレージに保存し、[最新問診を取得] を押すたびにサーバーへ送信します。設定の保存と取得はそれぞれ独立したボタンで制御できます。

以上の手順を踏むことで、任意の患者画面からワンクリックで最新の問診 Markdown を取得できるようになります。
