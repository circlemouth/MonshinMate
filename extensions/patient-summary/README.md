# 問診メイト Chrome拡張機能

患者名と生年月日から最新の問診をMarkdown形式で取得し、クリップボードにコピーするChrome拡張機能です。

## 📦 インストール方法

### 1. Chrome拡張機能管理ページを開く

以下のいずれかの方法で開きます：

- Chromeのアドレスバーに `chrome://extensions/` と入力してEnter
- Chromeメニュー（右上の︙）→ その他のツール → 拡張機能

### 2. デベロッパーモードを有効化

拡張機能ページの右上にある「**デベロッパーモード**」のトグルスイッチを**ON**にします。

### 3. 拡張機能を読み込む

1. 「**パッケージ化されていない拡張機能を読み込む**」ボタンをクリック
2. このフォルダ（`extensions/patient-summary`）を選択
3. 「選択」をクリック

### 4. インストール完了

Chromeのツールバーに拡張機能のアイコンが表示されます。

> **💡 ヒント**: アイコンが見えない場合は、パズルピースのアイコンをクリックして、ピンで固定できます。

## ⚙️ 初期設定

拡張機能を使用する前に、以下の4つの設定が必要です：

| 設定項目 | 説明 | 例 |
|---------|------|-----|
| **APIエンドポイント** | 管理画面のAPI連携で表示されるURL | `https://clinic.example.com/patient-summary` |
| **APIキー** | 管理画面で登録したAPIキー（最低16文字） | `your-secret-api-key-here` |
| **患者名のXPath** | 患者名が表示されているDOM要素のXPath | `//div[@id='patient-name']` |
| **生年月日のXPath** | 生年月日が表示されているDOM要素のXPath | `//span[@class='dob']` |

### XPathの取得方法

1. Chrome開発者ツールを開く（F12 または 右クリック → 検証）
2. 要素選択ツール（開発者ツール左上の矢印アイコン）をクリック
3. ページ上の対象要素（患者名や生年月日）をクリック
4. 開発者ツールのElements タブで要素が選択された状態で、右クリック
5. **Copy → Copy XPath** を選択
6. クリップボードにコピーされたXPathを拡張機能の設定に貼り付け

## ✨ 使い方

### 1. 患者情報ページを開く

患者名と生年月日が表示されているWebページに移動します。

### 2. 拡張機能を起動

Chromeツールバーの拡張機能アイコンをクリックします。

### 3. 設定を保存（初回のみ）

上記の4つの設定を入力し、「**設定を保存**」ボタンをクリックします。

### 4. 問診を取得

「**最新問診を取得**」ボタンをクリックします。

自動的に以下が実行されます：
1. ページから患者名と生年月日を抽出
2. 生年月日を標準形式（YYYY-MM-DD）に変換
3. APIに問診データをリクエスト
4. Markdown形式でクリップボードにコピー

### 5. 完了

デスクトップ通知が表示されたら完了です。クリップボードから任意の場所に貼り付けできます。

## 📝 機能の特徴

### 和暦・西暦対応

以下のような様々な日付フォーマットを自動的にISO形式（YYYY-MM-DD）に変換します：

- **和暦**: 令和5年12月1日、平成31年4月30日、昭和64年1月7日
- **西暦**: 2025/12/01、2025-12-01、2025.12.01
- **英字表記**: R5.12.01、H31.4.30、S64.1.7
- **漢字混在**: 2025年12月1日

### 複数フォーマット対応

- スラッシュ（/）、ピリオド（.）、ハイフン（-）区切り
- 和暦の「元年」表記にも対応

### その他の機能

- デスクトップ通知による完了通知
- 自動クリップボードコピー
- 設定の自動保存（Chrome Sync使用）

## 🔧 トラブルシューティング

### エラー: 「XPathから値を取得できませんでした」

**原因**: XPathが正しくない、または要素が見つからない

**解決方法**:
1. XPathが正しくコピーされているか確認
2. ページが完全に読み込まれた後に実行
3. 動的に生成される要素の場合、要素が表示された後に実行

### エラー: 「APIエラー」

**原因**: APIエンドポイントまたはAPIキーが正しくない

**解決方法**:
1. APIエンドポイントのURLを確認（末尾のスラッシュなど）
2. APIキーが正しいか確認
3. API側のログを確認

### 通知が表示されない

**原因**: ブラウザの通知権限が許可されていない

**解決方法**:
1. Chromeの設定 → プライバシーとセキュリティ → サイトの設定 → 通知
2. 拡張機能からの通知を許可

### クリップボードにコピーされない

**原因**: クリップボード権限のエラー

**解決方法**:
1. 拡張機能を再読み込み
2. Chromeを再起動
3. セキュリティソフトがクリップボードへのアクセスをブロックしていないか確認

## 🔒 セキュリティとプライバシー

- APIキーは Chrome の secure storage に暗号化されて保存されます
- 患者情報は拡張機能内で一時的に処理されるのみで、保存されません
- 通信は HTTPS 経由で行われます（APIエンドポイントがHTTPSの場合）

## 📄 ファイル構成

```
patient-summary/
├── manifest.json    # Chrome拡張機能のマニフェストファイル
├── popup.html       # ポップアップUIのHTML
├── popup.js         # メインロジック（患者情報取得、API通信）
└── README.md        # このファイル
```

## 🛠️ 開発者向け情報

### 権限

- `storage`: 設定の保存（Chrome Sync使用）
- `scripting`: XPathによるDOM要素の取得
- `tabs`: アクティブタブへのアクセス
- `<all_urls>`: 任意のページでXPath実行を許可

### API仕様

#### リクエスト

```http
POST {apiUrl}
Content-Type: application/json
X-MonshinMate-Api-Key: {apiKey}

{
  "patient_name": "患者名",
  "dob": "YYYY-MM-DD"
}
```

#### レスポンス

```json
{
  "markdown": "# 問診結果\n..."
}
```

### 日付正規化ロジック

`popup.js` の `normalizeDob()` 関数が以下の処理を行います：

1. `normalizeStandardDate()`: 西暦フォーマットの解析
2. `normalizeEraDate()`: 和暦フォーマットの解析
3. 両方失敗した場合は元の文字列を返す

## 📞 サポート

問題が発生した場合は、開発者ツールのConsoleを確認してエラーログをチェックしてください。

## 📜 ライセンス

このプロジェクト固有のライセンスに従います。
