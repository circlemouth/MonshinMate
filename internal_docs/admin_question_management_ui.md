# 問診項目管理画面 UI 改装検討メモ

## 1. 改装の目的
- 管理者が問診項目と回答ごとの追質問の構造を一目で把握できるようにする。
- 問診項目の挿入・編集・並べ替えを、フォーム全体をスクロールしなくても完結できるようにする。
- 既存テンプレート資産（API スキーマ・保存フォーマット）を変えずに UI を差し替える。

## 2. 現状の課題整理
- 現行 UI はカードが縦に連続しており、追質問はモーダルを開かないと構造が把握できない。
- 選択肢ごとに追質問が定義されているかが視覚的にわからず、レビュー時の抜け漏れが発生しやすい。
- 新規問診項目は一覧の末尾にしか追加できないため、既存の質問の間に挿入したい場合はドラッグ＆ドロップで大きく移動する必要がある。

## 3. 目指す UI の概要
1. **階層ツリー表示**
   - 問診項目を縦方向のタイムライン／ステップ表示にし、各選択肢の追質問を枝分かれとして右側に展開。
   - 追質問を持つ選択肢にはバッジ（`追`）とコネクタラインを表示し、クリックで展開／折りたたみ。
   - キーボードフォーカス時にも階層がわかるように左側の縦線の太さ・色を変える。
2. **インライン編集パネル**
   - 各問診項目カードの右側に詳細パネルを設け、追質問や選択肢をその場で編集可能にする。
   - 分岐の追加も同じパネル上で完結させ、モーダル遷移を廃止する。
3. **差し込み用の挿入ボタン**
   - 各問診項目カードの境界に「＋ この位置に追加」ボタン（`AddDivider` コンポーネント）を配置。
   - ボタン押下で新規項目モーダル（もしくはスライドオーバー）を開き、確定後に指定位置へ即挿入。
   - ドラッグ＆ドロップは従来どおり保持しつつ、細かい挿入はワンクリックで済むようにする。

## 4. 実装アーキテクチャ案
- **データモデル**: 既存の `QuestionItem` を `QuestionNode` にマッピングし、`children` に追質問を格納。UI 側では `TreeNode` として整形して扱う。
- **状態管理**: `useQuestionTree` フックでノード展開状態、選択中ノード、ドラフト内容を集中管理。既存の `useTemplateEditor` を内包する形で導入し、API コールは変更しない。
- **コンポーネント構成**:
  - `QuestionTreeView` … 左側のツリー（問診項目＋分岐ライン）。
  - `QuestionDetailPanel` … 右側の編集フォーム（共通項目＋タイプ別設定）。
  - `BranchBadge` / `BranchConnector` … 分岐の有無を示すラベル・線。
  - `InsertDivider` … 問診項目間に表示する差し込みボタン。フォーカスリング対応。
- **アクセシビリティ**: ツリーは `role="tree"` / `role="treeitem"` を付与し、分岐展開は `aria-expanded` で管理。キーボードは上下キーで移動、左右キーで展開／折りたたみ。
- **レスポンシブ**: `md` 以上は左右 2 カラム、`sm` ではツリー→詳細の順に縦スタックし、詳細はディスクロージャで折りたたみ可能にする。

## 5. 既存ユーザーへの影響と移行策
- データ構造は既存 API の `followups` フィールドをそのまま利用するため移行不要。
- UI の操作が大きく変わるため、初回表示時にツアー（`react-joyride` 等）で新 UI を案内する。
- 差し込みボタンはアクセシビリティを考慮し、キーボード操作でも利用できるよう `button` 要素＋ショートカットキー（例: `Ctrl+Enter`）を検討。
- リリース前に既存テンプレートを開いて状態が保持されているか QA を実施。Undo/Redo の既存実装を壊さないように Hook 追加時にテストを更新。

## 6. 想定されるワークフロー
1. テンプレートを開くと、左側にツリー（問診項目 + 分岐）が縦に並ぶ。
2. 分岐のある選択肢には青色バッジ「追」が付き、クリックすると子ノードが右側に表示される。
3. ノードを選択すると右側の詳細パネルで質問文・入力方式・回答分岐を編集できる。
4. ノード間の「＋ この位置に追加」ボタンを押すと挿入ダイアログが開き、確定後その場所に新しい問診項目カードが現れる。
5. 追質問の追加は詳細パネルで「分岐を追加」ボタンを押し、対象となる選択肢を選ぶだけでツリーに反映される。

## 7. 検証計画
- **UI プロトタイプ**: Storybook で `QuestionTreeView` のモックデータを表示し、階層表示が要件を満たすか確認。
- **ユーザビリティテスト**: スタッフ 2 名にプロトタイプを触ってもらい、追質問の構造理解と差し込み操作が 1 分以内で完了するか計測。
- **パフォーマンス**: 50 項目 × 各 4 分岐のケースでレンダリング時間と応答性を測定。必要に応じて仮想スクロール（`react-virtual`）を導入。

## 8. 今後のタスク
- [ ] Figma でツリー UI のワイヤーフレームを作成。
- [ ] `QuestionTreeView` と `QuestionDetailPanel` の Storybook を作成し、UI/UX チームに共有。
- [ ] 既存 E2E（テンプレート編集）をツリー UI 対応にリライトし、差し込みボタンのテストケースを追加。
- [ ] リリースノート案を作成し、既存ユーザー向けの変更点と操作方法を記載。

## 9. 実装メモ（2025-09-28）
- 管理画面のテンプレート編集に `QuestionTreeView` を導入し、左カラムで追質問の分岐を階層表示できるようにした。ツリーから問診項目を選択すると右側の編集フォームがフォーカスされる。
- ツリーおよび一覧の境界に「この位置に追加」ボタンを配置し、任意の位置へトップレベルの問診項目を差し込めるようにした。差し込み時はフォーム上部に挿入位置をテキストで表示する。
- 従来の一覧（テーブル）は右カラムにまとめ、ツリーと同時に確認しながら編集できる 2 カラムレイアウトとした。

